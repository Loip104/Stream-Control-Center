<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Stream Control Center</title>
    <style>
	:root {
    --twitch-purple: #9146FF;
    --twitch-purple-hover: #772ce8;
}
        {% for font in fonts %}
        @font-face {
            font-family: '{{ font }}';
            src: url('/fonts/{{ font }}');
        }
        {% endfor %}

        body { font-family: sans-serif; background-color: #f4f4f9; color: #333; margin: 20px; }
        h1, h2, h3 { color: #6441a5; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab-nav { border-bottom: 2px solid #ddd; display: flex; }
        .tab-button { background-color: #f0f0f0; border: 1px solid #ddd; border-bottom: none; border-radius: 5px 5px 0 0; padding: 15px 20px; font-size: 16px; cursor: pointer; color: #333; margin-right: 5px; position: relative; top: 1px; }
        .tab-button:hover { background-color: #e0e0e0; }
        .tab-button.active { background-color: #fff; border-bottom: 1px solid #fff; font-weight: bold; color: #6441a5; }
        .tab-content { display: none; padding-top: 20px; }
        .tab-content.active { display: block; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .settings-group { border: 2px solid #eee; padding: 15px; border-radius: 5px; background-color: #fafafa; }
        .settings-group h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        label { margin-bottom: 5px; font-weight: bold; font-size: 14px; display: block; }
        input[type="text"], input[type="password"], input[type="number"], select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        button { background-color: #6441a5; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        button:hover { background-color: #523486; }
        .button-like { color: white; padding: 10px 20px; border-radius: 4px; font-size: 16px; }
        fieldset { border: none; padding: 0; margin: 0; }
		
		
        #library-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
		#library-table th, #library-table td { border-right: 1px solid #ddd; }
		#library-table th:last-child, #library-table td:last-child { border-right: none; }
		.sort-arrow { font-size: 0.6em; vertical-align: middle; }
        .video-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #ddd; gap: 10px; }
		.video-item.selected { background-color: #d6bfff !important; }
        .video-item.disabled { opacity: 0.5; }
        .video-item.disabled .drag-handle, .video-item.disabled .video-name { pointer-events: auto; }
        .video-item:nth-child(even) { background-color: #f9f9f9; }
        .drag-handle { cursor: grab; color: #999; font-size: 20px; flex-shrink: 0; }
        .thumbnail { width: 80px; height: 45px; object-fit: cover; border-radius: 3px; cursor: pointer; border: 1px solid #ddd; flex-shrink: 0; }
        .video-details { flex-grow: 1; flex-shrink: 1; min-width: 0; }
		.video-name { font-weight: bold; white-space: nowrap; overflow-x: hidden; text-overflow: ellipsis; padding-bottom: 5px; }
        .video-name:hover { overflow-x: auto; text-overflow: clip; }
        .video-meta { font-size: 12px; color: #666; }
        .video-inputs { flex-shrink: 0; display: grid; grid-template-columns: 200px 150px; gap: 10px; }
        .delete-form { margin-left: auto; flex-shrink: 0; }
        .flash { padding: 10px; border-radius: 4px; margin-bottom: 20px; border: 1px solid transparent; }
        .flash.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .flash.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .flash.warning { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
        .flash.info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        .status-box { padding: 15px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px; }
		.progress-bar-container { width: 100%; background-color: #ddd; border-radius: 5px; margin-top: 10px; height: 20px; position: relative; }
        #progress-bar-fill { width: 0%; height: 100%; background-color: #6441a5; border-radius: 5px; transition: width 0.5s ease-in-out; }
        #progress-text { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; text-shadow: 1px 1px 2px black; }
        .playlist-controls { display: flex; padding: 10px; background: #fafafa; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        .modal-content { margin: auto; display: block; max-width: 80%; max-height: 80%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .modal-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
		.process-controls { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        #log-output, #chat-log-output, #ffmpeg-log-output, #bot-log-output { background-color: #1e1e1e; font-family: Consolas, monospace; padding: 15px; border-radius: 5px; height: 300px; overflow-y: scroll; white-space: pre-wrap; word-wrap: break-word; }
        #log-output { color: #FFFFFF; }
        #ffmpeg-log-output { color: #FFFFFF; }
		#bot-log-output { color: #FFFFFF; }
		#chat-log-output { color: #FFFFFF; }
		.schedule-table { width: 100%; border-collapse: collapse; } .schedule-table th, .schedule-table td { border: 1px solid #ddd; padding: 8px; text-align: left; } .schedule-table th { background-color: #f2f2f2; }
        .event-inputs { display: flex; flex-direction: column; gap: 5px; }
        .rotation-list { border: 1px solid #ddd; padding: 10px; min-height: 400px; border-radius: 5px; background-color: #fafafa; }
		.rotation-item { padding: 8px 12px; margin-bottom: 5px; background-color: white; border: 1px solid #ccc; border-radius: 4px; cursor: grab; }
		.saved-rotation-item { display: flex; align-items: center; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; margin-bottom: 10px; }
   
		/* --- Stile für CTA & Navigations-Buttons --- */
		.cta-button { display: inline-block; background-color: var(--twitch-purple); color: white !important; padding: 15px 35px; border-radius: 8px; text-decoration: none; font-size: 1rem; font-weight: 600; transition: background-color 0.2s ease, transform 0.2s ease; border: none; cursor: pointer; }
		.cta-button:hover { background-color: var(--twitch-purple-hover); transform: translateY(-2px); }
		.nav-button { padding: 6px 12px !important; font-size: 0.85em !important; box-shadow: none !important; }

		.autocomplete-suggestions { position: absolute; border: 1px solid #ddd; border-top: none; background: #fff; max-height: 150px; overflow-y: auto; z-index: 99; }
		.autocomplete-suggestion { padding: 8px 12px; cursor: pointer; }
		.autocomplete-suggestion:hover { background: #f0f0f0; }
		.autocomplete-suggestion.active { background: var(--twitch-purple); color: white; }


</style>

</head>
<body>
    <form id="rename-form" action="/rename_video" method="post" style="display: none;">
        <input type="hidden" name="video_id" id="rename-video-id">
        <input type="hidden" name="new_name" id="rename-new-name">
    </form>
    <form id="rotation-form" action="/save_rotation" method="post" style="display: none;">
        <input type="hidden" name="rotation_name" id="rotation-name">
        <input type="hidden" name="playlist_ids" id="rotation-playlist-ids">
    </form>

<div class="app-info-bar">
    <h1>{{ _('Stream Control Center') }}</h1>
    <span>{{ _('Version:') }} <strong>{{ update_info.current_version }}</strong></span>
    {% if update_info and update_info.update_available %}
        <a href="https://hub.zeibig.me" target="_blank" class="update-link">{{ _('Update verfügbar: %(version)s!', version=update_info.new_version) }}</a>
    {% endif %}
    <nav class="main-nav">
        <a href="https://hub.zeibig.me" target="_blank" class="cta-button nav-button">{{ _('Stream-Control-Center Seite') }}</a>
        <a href="https://zeibig.me" target="_blank" class="cta-button nav-button">Zeibig.me</a>
        <a href="https://hub.zeibig.me/anleitung.html" target="_blank" class="cta-button nav-button">{{ _('Anleitung') }}</a>
        <a href="https://github.com/Loip104/Stream-Control-Center/issues/new/choose" target="_blank" class="cta-button nav-button">{{ _('Fehler melden') }}</a>
        <a href="https://github.com/Loip104/Stream-Control-Center" target="_blank" class="cta-button nav-button">GitHub</a>
    </nav>
</div>
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="flash {{ category }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}
<div class="status-box" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;" data-fetch-error="{{ _('Fehler') }}">
    <div>
        <strong>{{ _('Status:') }}</strong> 
        {{ _('Streamer:') }} <span id="status-text" style="font-weight:bold;">{{ _('Wird geladen...') }}</span> | 
        {{ _('Bot:') }} <span id="bot-status-text" style="font-weight:bold;">{{ _('Wird geladen...') }}</span>
    </div>
    <div>
        <strong>{{ _('Aktuell läuft:') }}</strong> <span id="status-np">{{ _('N/A') }}</span>
    </div>
    <div>
        <form action="/skip_video" method="post" style="display: inline-block; margin: 0;">
            <button type="submit" title="{{ _('Startet das nächste Video in der Playlist sofort.') }}" style="padding: 5px 10px; font-size: 14px;">{{ _('Nächster Titel') }}</button>
        </form>
        <form action="/restart_playlist" method="post" style="display: inline-block; margin: 0;">
            <button type="submit" title="{{ _('Startet die aktuell laufende Playlist sofort von vorne.') }}" style="padding: 5px 10px; font-size: 14px;">{{ _('Playlist Neustart') }}</button>
        </form>
    </div>
    <div class="progress-bar-container" style="width: 100%; display: none;">
        <div id="progress-bar-fill"></div>
        <span id="progress-text">00:00 / 00:00</span>
    </div>
</div>

<div class="tab-nav">
    <button class="tab-button {% if active_tab == 'playlist' %}active{% endif %}" onclick="openTab(event, 'playlist')">{{ _('Playlist') }}</button>
    <button class="tab-button {% if active_tab == 'rotations' %}active{% endif %}" onclick="openTab(event, 'rotations')">{{ _('Rotationen') }}</button>
    <button class="tab-button {% if active_tab == 'library' %}active{% endif %}" onclick="openTab(event, 'library')">{{ _('Bibliothek') }}</button>
    <button class="tab-button {% if active_tab == 'schedule' %}active{% endif %}" onclick="openTab(event, 'schedule')">{{ _('Sendeplan') }}</button>
    <button class="tab-button {% if active_tab == 'process' %}active{% endif %}" onclick="openTab(event, 'process')">{{ _('Prozess-Steuerung') }}</button>
    <button class="tab-button {% if active_tab == 'settings' %}active{% endif %}" onclick="openTab(event, 'settings')">{{ _('Streamer-Config') }}</button>
    <button class="tab-button {% if active_tab == 'manager_config' %}active{% endif %}" onclick="openTab(event, 'manager_config')">{{ _('Manager-Config') }}</button>
    <button class="tab-button {% if active_tab == 'bot' %}active{% endif %}" onclick="openTab(event, 'bot')">{{ _('Bot') }}</button>
</div>
<div class="container">

<div id="bot" class="tab-content {% if active_tab == 'bot' %}active{% endif %}">
    <hr style="margin-top: 20px;">
    <h3>{{ _('Befehls-Verwaltung') }}</h3>
    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; margin-bottom: 15px;">
        <table class="schedule-table">
            <thead>
                <tr>
                    <th>{{ _('Befehl') }}</th>
                    <th>{{ _('Aktionstyp') }}</th>
                    <th>{{ _('Details') }}</th>
                    <th>{{ _('Berechtigung') }}</th>
                    <th>{{ _('Bot-Antwort') }}</th>
                    <th>{{ _('Aktion') }}</th>
                </tr>
            </thead>
            <tbody>
                {% for command, details in bot_commands.items() %}
                <tr>
                    <td><strong>{{ command }}</strong></td>
                    <td>{{ details.action.type }}</td>
                    <td>
                        {% if details.action.type == 'stream_control' %} {{ _('Befehl:') }} {{ details.action.command }}
                        {% elif details.action.type == 'chat_reply' %} {{ _('Nachricht:') }} {{ details.action.message }}
                        {% endif %}
                    </td>
                    <td>{{ details.permissions }}</td>
                    <td style="font-family: monospace; font-size: 12px;">{{ details.response or '-' }}</td>
                    <td>
						<form action="/delete_bot_command" method="post" style="margin: 0;">
							<input type="hidden" name="command_name" value="{{ command }}">
							<button type="submit" style="background: #c82333; padding: 2px 8px; font-size: 12px;"
									data-confirm-msg="{{ _("Befehl '%(command)s' wirklich löschen?", command=command) }}"
									onclick="if(!confirm(this.dataset.confirmMsg)) return false;">
								X
							</button>
						</form>
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="6" style="text-align: center;">{{ _('Keine Befehle konfiguriert.') }}</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

<h4>{{ _('Neuen Befehl hinzufügen') }}</h4>
<form action="/add_bot_command" method="post" class="settings-group" style="padding: 15px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: flex-end;">
        <div>
            <label>{{ _('Befehl (z.B. !next)') }}</label>
            <input type="text" name="command_name" required>
        </div>
        <div>
            <label>{{ _('Berechtigung') }}</label>
            <select name="permissions">
                <option value="everyone">{{ _('Jeder') }}</option>
                <option value="moderator">{{ _('Moderatoren') }}</option>
            </select>
        </div>
        <div>
            <label>{{ _('Cooldown (Sekunden)') }}</label>
            <input type="number" name="cooldown" value="10" min="0">
        </div>
        <div>
            <label>{{ _('Aktionstyp') }}</label>
            <select name="action_type" id="action-type-select">
                <option value="stream_control">{{ _('Stream steuern') }}</option>
                <option value="chat_reply">{{ _('Chat-Antwort') }}</option>
            </select>
        </div>
        
        <div id="params-stream_control" class="action-params">
            <label>{{ _('Befehl an Streamer') }}</label>
            <select name="stream_control_command">
                <option value="skip_track">{{ _('Titel überspringen') }}</option>
                <option value="restart_playlist">{{ _('Playlist neustarten') }}</option>
            </select>
        </div>

        <div id="params-chat_reply" class="action-params" style="display: none;">
            <label>{{ _('Nachricht für Chat-Antwort') }}</label>
            <input type="text" name="chat_reply_message" placeholder="{{ _('Verwende {platzhalter}') }}">
        </div>
    </div>
    <div style="margin-top: 10px;">
        <label>{{ _('Antwort des Bots nach Aktion (optional)') }}</label>
        <input type="text" name="response" placeholder="{{ _('@{user} wird durch den Namen des Nutzers ersetzt.') }}">
    </div>
    <button type="submit" style="margin-top: 15px;">{{ _('Befehl hinzufügen') }}</button>
</form>
<h2>{{ _('Bot Prozess-Steuerung') }}</h2>
<h3 style="margin-top: 20px;">{{ _('Live Chat') }}</h3>
<pre id="chat-log-output" style="height: 400px; color: #d4d4d4;"></pre>
<div class="process-controls">
    {% if bot_is_running %}
        <div class="status-indicator">
            <span style="color: green; font-weight: bold;">✔ {{ _('Bot-Prozess läuft') }}</span>
			<form action="/stop_bot" method="post" style="margin: 0;">
				<button type="submit" style="background-color: #dc3545;"
						data-confirm-msg="{{ _('Bist du sicher, dass du den Bot-Prozess beenden möchtest?') }}"
						onclick="if(!confirm(this.dataset.confirmMsg)) return false;">
					{{ _('Bot Stoppen') }}
				</button>
			</form>
        </div>
    {% else %}
        <div class="status-indicator">
            <span style="color: red; font-weight: bold;">✖ {{ _('Bot-Prozess ist offline') }}</span>
            <form action="/start_bot" method="post" style="margin: 0;">
                <button type="submit" style="background-color: #28a745;">{{ _('Bot Starten') }}</button>
            </form>
        </div>
    {% endif %}
</div>

<h3>{{ _('Live-Log (`bot.log`)') }}</h3>
<pre id="bot-log-output">{{ _('Log-Daten werden geladen...') }}</pre>

</div>


<div id="playlist" class="tab-content {% if active_tab == 'playlist' %}active{% endif %}">
    
    <div class="playlist-controls" style="flex-direction: column; align-items: flex-start;">
        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center; flex-wrap: wrap; gap: 15px;">
            
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                
                <form method="get" style="display: flex; align-items: center; gap: 10px;">
                    <label for="playlist-select-editor" style="margin-bottom: 0;">{{ _('Playlist-Editor:') }}</label>
                    <input type="hidden" name="active_tab" value="playlist">
                    <select name="edit_playlist" id="playlist-select-editor" onchange="this.form.submit()">
                        {% for pl_id, pl_info in playlists_db.items() %}
                            <option value="{{ pl_id }}" {% if pl_id == manager_config.editing_playlist_id %}selected{% endif %}>
                                {{ pl_info.name }}
                            </option>
                        {% endfor %}
                    </select>
                </form>

				<form action="/delete_playlist" method="post">
					<input type="hidden" name="playlist_to_delete" value="{{ playlists_db.get(manager_config.editing_playlist_id, {}).get('filename', '') }}">
					<button type="submit" style="background-color: #c82333;"
						data-confirm-msg="{{ _('Sicher, dass du die ausgewählte Playlist und die .csv-Datei permanent löschen möchtest?') }}"
						onclick="if(!confirm(this.dataset.confirmMsg)) return false;">
						{{ _('Geladene Playlist löschen') }}
					</button>
				</form>
            </div>

            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <span>{{ _('Gesamtdauer:') }} <strong>{{ total_duration }}</strong></span>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <label for="sort-playlist-by" style="margin-bottom: 0; font-weight: normal;">{{ _('Sortieren nach:') }}</label>
                    <select id="sort-playlist-by" style="width: auto; margin-bottom: 0;">
                        <option value="basename">{{ _('Dateiname') }}</option>
                        <option value="title">{{ _('Titel') }}</option>
                        <option value="game">{{ _('Spiel') }}</option>
                    </select>
                    <button type="button" onclick="sortPlaylist()">{{ _('Sortieren') }}</button>
                </div>
                <button type="button" onclick="bulkSetStatus(true)">{{ _('Alle aktivieren') }}</button>
                <button type="button" onclick="bulkSetStatus(false)">{{ _('Alle deaktivieren') }}</button>
            </div>
        </div>

        <div style="background-color: #e6f7ff; border: 1px solid #91d5ff; padding: 10px; border-radius: 5px; margin-top: 15px; width: 100%; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <div>
                <strong>{{ _('Für den Stream aktiv:') }}</strong> 
                <span style="font-family: monospace; background: #f0f0f0; padding: 2px 5px; border-radius: 3px;">
                    {{ active_playlist_info.name if active_playlist_info else _('Keine') }}
                </span>
            </div>
            
            <form action="/switch_playlist" method="post" style="display: flex; gap: 10px;">
                <input type="hidden" name="playlist_to_activate" value="{{ playlists_db.get(manager_config.editing_playlist_id, {}).get('filename', '') }}">
                <button type="submit" name="restart_mode" value="soft" style="background-color: #52c41a;">
                    {{ _("'%(name)s' aktivieren (Sanft)", name=playlists_db.get(manager_config.editing_playlist_id, {}).get('name', '')) }}
                </button>
                <button type="submit" name="restart_mode" value="hard" style="background-color: #faad14;">
                    {{ _("'%(name)s' aktivieren (Sofort)", name=playlists_db.get(manager_config.editing_playlist_id, {}).get('name', '')) }}
                </button>
            </form>
        </div>
    </div>

    <input type="text" id="search-box" onkeyup="filterPlaylist()" placeholder="{{ _('Playlist durchsuchen...') }}" style="margin-top: 15px;">

    <form id="playlist-form" method="post" action="javascript:void(0);">
        <input type="hidden" name="editing_playlist_id" value="{{ manager_config.editing_playlist_id }}">
        
        <div id="playlist-items">
            {% for video in videos %}
            <div class="video-item {% if video.status == '0' %}disabled{% endif %}">
                <span class="drag-handle" title="{{ _('Ziehen zum Neuanordnen') }}">☰</span>
                
					<button type="button"
							data-alert-error="{{ _('Fehler beim Duplizieren.') }}"
							onclick="duplicateEntry(this, '{{ loop.index0 }}', '{{ manager_config.editing_playlist_id }}')" 
							title="{{ _('Diesen Eintrag duplizieren') }}" 
							style="border:none; background:gray; cursor:pointer; padding: 0 5px; font-size: 1.3em;">❐</button>

                <div class="status-toggle">
                    <input type="checkbox" name="active_videos" value="{{ video.id }}" {% if video.status == '1' %}checked{% endif %} onchange="this.closest('.video-item').classList.toggle('disabled', !this.checked);">
                </div>

                <img src="/thumbnail/{{ video.id }}" class="thumbnail" onclick="openModal(this.src)" onerror="this.style.display='none'">                
                <div class="video-details">
                    <div class="video-name" title="{{ video.filename }}">{{ video.basename }}</div>
                    <div class="video-meta">{{ video.duration_str }} | {{ video.size_str }}</div>
                </div>

                <div class="video-inputs">
                    <input type="hidden" name="video_id" value="{{ video.id }}">
                    <input type="text" name="title" value="{{ video.title }}" placeholder="{{ _('Titel') }}">
                    <input type="text" name="game" value="{{ video.game }}" placeholder="{{ _('Spiel / Kategorie') }}">
                </div>
                
				<div class="delete-form" style="display: flex; gap: 5px;">
                    <button type="button" 
                        data-confirm-msg="{{ _('Soll der Eintrag wirklich aus der Playlist entfernt werden?') }}"
                        data-alert-error="{{ _('Fehler beim Entfernen.') }}"
                        onclick="removeEntry(this, '{{ loop.index0 }}', '{{ manager_config.editing_playlist_id }}')" 
                        title="{{ _('Nur diesen Playlist-Eintrag entfernen') }}" 
                        style="background-color: #6c757d;">X</button>
                </div>
            </div>
            {% endfor %}
        </div>
        <br>
        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 15px; margin-top: 10px;">
            <div>
                <button type="button"
                    data-alert-error="{{ _('Fehler beim Speichern:') }}"
                    data-alert-fatal-error="{{ _('Ein Fehler ist aufgetreten. Prüfe die Konsole.') }}"
                    onclick="savePlaylistChanges(this)" style="background-color: #28a745;">
                    {{ _('Änderungen speichern') }}
                </button>
            </div>
        </div>
    </form>
</div>

<div id="rotations" class="tab-content {% if active_tab == 'rotations' %}active{% endif %}">
            <h2>{{ _('Playlist-Rotationen') }}</h2>
            <p>{{ _('Erstelle eine Abfolge von Playlists, die zu einer großen Master-Playlist zusammengefügt werden. Ziehe Playlists von links nach rechts, um sie zur Rotation hinzuzufügen.') }}</p>
			<div style="margin-bottom: 10px; display: flex; gap: 10px; align-items: center;">
				<input type="text" id="rotation-name-input" placeholder="{{ _('Name der Rotation...') }}" style="width: 300px; margin-bottom: 0;" value="{{ rotation_name_to_edit }}">
				<button type="button"
					data-alert-enter-name="{{ _('Bitte gib einen Namen für die Rotation ein.') }}"
					data-alert-empty="{{ _('Die Rotation ist leer. Bitte ziehe Playlists in den Ablauf.') }}"
					onclick="saveRotation(this)">
					{{ _('Speichern & Kompilieren') }}
				</button>
			</div>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                <div>
                    <h4>{{ _('Verfügbare Playlists') }}</h4>
                    <div id="available-playlists" class="rotation-list">
                        {% for pl_id, pl_info in playlists_db.items() %}
                        <div class="rotation-item" data-id="{{ pl_id }}">{{ pl_info.name }}</div>
                        {% endfor %}
                    </div>
                </div>
                <div>
                    <h4>{{ _('Rotations-Ablauf') }}</h4>
                    <div id="rotation-sequence" class="rotation-list">
                        {% for item in rotation_to_edit %}
                        <div class="rotation-item" data-id="{{ item.id }}">{{ item.name }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
<hr style="margin-top: 25px;">
        <h3 style="margin-top: 20px;">{{ _('Gespeicherte Rotationen') }}</h3>
        <div id="saved-rotations-list">
            {% if not rotations_db %}
                <p>{{ _('Noch keine Rotationen gespeichert.') }}</p>
            {% else %}
                {% for rot_id, rot_info in rotations_db.items() %}
                <div class="saved-rotation-item">
                    <span><strong>{{ rot_info.name }}</strong> ({{ _('%(count)s Playlists', count=rot_info.playlist_ids|length) }})</span>
                    <div style="margin-left: auto; display: flex; gap: 10px;">
                        <a href="?active_tab=rotations&load_rotation={{ rot_id }}" class="button-like" style="background-color: #6c757d; text-decoration: none;">{{ _('Bearbeiten') }}</a>
						<form action="/delete_rotation" method="post" style="display: inline-block; margin: 0;">
							<input type="hidden" name="rotation_id" value="{{ rot_id }}">
							<button type="submit" style="background-color: #c82333;"
									data-confirm-msg="{{ _("Bist du sicher, dass du die Rotation '%(name)s' permanent löschen möchtest?", name=rot_info.name) }}"
									onclick="if(!confirm(this.dataset.confirmMsg)) return false;">
								{{ _('Löschen') }}
							</button>
						</form>
                    </div>
                </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>

        <div id="library" class="tab-content {% if active_tab == 'library' %}active{% endif %}">
    <h2>{{ _('Globale Video-Bibliothek') }}</h2>
    <p>{{ _('Hier siehst du alle Videos, die in deinen konfigurierten Ordnern gefunden wurden.') }}</p>
    <div style="background-color: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
        <h4>{{ _('Analyse- & Verwaltungs-Werkzeuge') }}</h4>
        <div style="display:flex; gap: 10px; flex-wrap: wrap;">
            <form action="/sync_library" method="post" style="display: inline-block;">
                <button type="submit" style="background-color: #17a2b8;">{{ _('Bibliothek synchronisieren') }}</button>
            </form>
            <form action="/find_orphaned_videos" method="post" style="display: inline-block;">
                <button type="submit">{{ _('Ungenutzte Videos finden') }}</button>
            </form>
            <form action="/import_new_videos" method="post" style="display: inline-block;">
                <button type="submit">{{ _('Neue Videos importieren') }}</button>
            </form>
            <form action="/generate_thumbnails" method="post" style="display: inline-block;">
                <button type="submit">{{ _('Fehlende Thumbnails generieren') }}</button>
            </form>
        </div>
        {% if orphaned_videos_result is not none %}
        <div style="margin-top: 15px;">
            <strong>{{ _('Ergebnis der Analyse:') }}</strong>
            {% if orphaned_videos_result %}
            <ul style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: white; list-style-type: none; margin:0;">
                {% for video_path in orphaned_videos_result %}
                <li style="font-family: monospace; font-size: 12px;">{{ video_path }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <p style="margin-bottom: 0;">{{ _('Keine ungenutzten Videos gefunden. Alle Videodateien sind in mindestens einer Playlist enthalten.') }}</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
    <form method="post">
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; align-items: flex-end;">
            <div style="border-right: 2px solid #ddd; padding-right: 15px; display: flex; gap: 15px; align-items: flex-end;">
                <div>
                    <label for="playlist-select-target" style="margin-bottom:0;">{{ _('Auswahl hinzufügen zu:') }}</label>
                    <select name="playlist_select_target" id="playlist-select-target" style="width:auto; margin-bottom: 0;">
                        {% for pl_id, pl_info in playlists_db.items() %}
                            <option value="{{ pl_info.filename }}" {% if pl_id == manager_config.active_playlist_id %}selected{% endif %}>
                                {{ pl_info.name }}
                            </option>
                        {% endfor %}
                    </select>
                    <button type="submit" formaction="/add_to_playlist" style="background-color: #28a745;">{{ _('Hinzufügen') }}</button>
                </div>
                <div>
                    <label for="new_playlist_name_from_lib" style="margin-bottom:0;">{{ _('Neue Playlist aus Auswahl erstellen:') }}</label>
                    <input type="text" id="new_playlist_name_from_lib" name="new_playlist_name" placeholder="{{ _('Name für neue Playlist...') }}" style="width:auto; margin-bottom: 0;">
                    <button type="submit" formaction="/create_playlist_from_selection">{{ _('Erstellen') }}</button>
                </div>
            </div>
				<div>
					<label style="margin-bottom:0;">{{ _('Ausgewählte Dateien:') }}</label>
					<button type="submit" 
							formaction="/delete_files_from_library" 
							style="background-color: #dc3545;"
							data-confirm-msg="{{ _('WARNUNG:\n\nDie ausgewählten Videos werden permanent von der Festplatte gelöscht. Diese Aktion kann nicht rückgängig gemacht werden.\n\nFortfahren?') }}"
							onclick="if(!confirm(this.dataset.confirmMsg)) return false;">
						{{ _('Permanent Löschen') }}
					</button>
				</div>
            <div style="margin-left: auto;">
                 <input type="text" id="library-search-box" onkeyup="filterLibrary()" placeholder="{{ _('Bibliothek durchsuchen...') }}" style="width:auto; margin-bottom: 0;">
            </div>
        </div>
        <div style="max-height: 600px; overflow-y: auto; border: 1px solid #ddd;">
            <table id="library-table" style="width: 100%; border-collapse: collapse;">
                <thead style="position: sticky; top: 0; background-color: #f2f2f2;">
                    <tr>
                        <th style="padding: 8px;"><input type="checkbox" onclick="toggleAllCheckboxes(this)"></th>
                        <th style="padding: 8px; text-align: left; cursor: pointer;" onclick="sortTable(1, 'library-table')">{{ _('Datei') }}<span class="sort-arrow"></span></th>
                        <th style="padding: 8px; text-align: left; cursor: pointer;" onclick="sortTable(2, 'library-table')">{{ _('In Playlists') }}<span class="sort-arrow"></span></th>
                        <th style="padding: 8px; text-align: left; cursor: pointer;" onclick="sortTable(3, 'library-table')">{{ _('Dauer') }}<span class="sort-arrow"></span></th>
                        <th style="padding: 8px; text-align: left; cursor: pointer;" onclick="sortTable(4, 'library-table')">{{ _('Größe') }}<span class="sort-arrow"></span></th>
                        <th style="padding: 8px; text-align: left; cursor: pointer;" onclick="sortTable(5, 'library-table')">{{ _('Pfad') }}<span class="sort-arrow"></span></th>
                        <th style="padding: 8px; text-align: center;">{{ _('Aktionen') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for video in all_disk_videos %}
                    <tr>
                        <td style="padding: 8px; border-top: 1px solid #ddd; text-align: center;"><input type="checkbox" name="selected_videos" value="{{ video.id }}"></td>
                        <td style="padding: 8px; border-top: 1px solid #ddd;">{{ video.basename }}</td>
                        <td style="padding: 8px; border-top: 1px solid #ddd; font-size: 11px; color: #333;">
                            {% if video_playlist_map.get(video.id) %}
                                {{ video_playlist_map.get(video.id) | join(', ') }}
                            {% else %}
                                <span style="color: #999;">-</span>
                            {% endif %}
                        </td>
                        <td style="padding: 8px; border-top: 1px solid #ddd;">{{ video.duration_str }}</td>
                        <td style="padding: 8px; border-top: 1px solid #ddd;">{{ video.size_str }}</td>
                        <td style="padding: 8px; border-top: 1px solid #ddd; font-size: 12px; color: #666;" title="{{ video.path }}">{{ video.path }}</td>
                        <td style="padding: 8px; border-top: 1px solid #ddd; text-align: center;">
						<button type="button" 
								data-prompt-message="{{ _('Bitte gib den neuen Dateinamen ein (ohne Endung):') }}"
								onclick="promptToRename(this, '{{ video.id }}', '{{ video.basename }}')" 
								title="{{ _('Video umbenennen') }}" 
								style="padding: 2px 8px; font-size: 14px;">
							✏️
						</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
</div>

<div id="schedule" class="tab-content {% if active_tab == 'schedule' %}active{% endif %}">
            <h2>{{ _('Wöchentlicher Sendeplan') }}</h2>
            <p>{{ _('Leere Einträge werden ignoriert. Wenn für eine Zeit kein Event geplant ist, wird die "Default Playlist" aus der <code>schedule.json</code> verwendet.') }}</p>
            <form action="/save_schedule" method="post">
                <div style="overflow-x: auto;">
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>{{ _('Tag') }}</th>
                            <th>{{ _('Event 1') }}</th>
                            <th>{{ _('Event 2') }}</th>
                            <th>{{ _('Event 3') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'] %}
                        {% for day in days %}
                        <tr>
                            <td><strong>{{ day.capitalize() }}</strong></td>
                            {% for i in range(3) %}
                            <td>
                                <div class="event-inputs">
                                    <select name="{{day}}_playlist_{{i}}" style="margin-bottom: 5px;">
                                        <option value="">-- {{ _('Keine Playlist') }} --</option>
                                        {% set event = schedule.get(day, [])[i] if schedule.get(day, [])|length > i else {} %}
                                        {% for pl_id, pl_info in playlists_db.items() %}
                                            <option value="{{ pl_id }}" {% if pl_id == event.playlist %}selected{% endif %}>
                                                {{ pl_info.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    
                                    <div style="display: flex; gap: 5px; align-items: center;">
                                        <input type="time" name="{{day}}_start_time_{{i}}" value="{{ event.start_time or '' }}">
                                        <select name="{{day}}_mode_{{i}}" onchange="toggleScheduleInputs(this)">
                                            <option value="time" {% if event.mode == 'time' or not event.mode %}selected{% endif %}>{{ _('bis') }}</option>
                                            <option value="repeat" {% if event.mode == 'repeat' %}selected{% endif %}>{{ _('x mal') }}</option>
                                        </select>
                                        <input type="time" name="{{day}}_end_time_{{i}}" value="{{ event.end_time or '' }}" class="schedule-input-time" style="display: {% if event.mode == 'repeat' %}none{% else %}block{% endif %};">
                                        <input type="number" name="{{day}}_repeat_{{i}}" value="{{ event.repeat or 1 }}" min="1" class="schedule-input-repeat" style="width: 60px; display: {% if event.mode == 'repeat' %}block{% else %}none{% endif %};">
                                    </div>
                                </div>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
                <br>
                <button type="submit">{{ _('Sendeplan speichern') }}</button>
            </form>
        </div>
		
		
<div id="settings" class="tab-content {% if active_tab == 'settings' %}active{% endif %}">
    <h2>{{ _('Streamer Konfiguration (`config.json`)') }}</h2>
    <form action="/save_settings" method="post" data-alert-save-error="{{ _('Ein Fehler beim Speichern ist aufgetreten. Bitte die Konsole prüfen.') }}">
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px;">

            <div class="settings-group">
                <h3>{{ _('Twitch API') }}</h3>
                <p style="font-size: 12px; color: #666; margin-top: -10px;">{{ _('Für die automatische Token-Erneuerung. Muss nur einmal eingerichtet werden.') }}</p>
                <a href="/connect_twitch" class="cta-button" style="width: 100%; text-align: center; box-sizing: border-box; margin-bottom: 15px;">{{ _('Mit Twitch verbinden') }}</a>
                <label>{{ _('Client-ID:') }}</label>
                <input type="text" name="twitch_client_id" value="{{ streamer_config.twitch_api.client_id }}">
                <label>{{ _('Client Secret:') }}</label>
                <input type="password" name="twitch_client_secret" placeholder="{% if client_secret_exists %}••••••••••••••••{% else %}{{ _('Wird zum Einrichten oder Ändern benötigt') }}{% endif %}">
                <label>{{ _('Kanalname:') }}</label>
                <input type="text" name="twitch_channel_name" value="{{ streamer_config.twitch_api.channel_name }}">
            </div>

            <div class="settings-group">
                <h3>{{ _('Stream') }}</h3>
                <label>{{ _('Stream Key:') }}</label>
                <input type="password" name="stream_key" placeholder="{{ _('Wird nicht angezeigt, kann aber überschrieben werden') }}">
                <label>{{ _('RTMP URL ({STREAM_KEY} wird ersetzt):') }}</label>
                <input type="text" name="rtmp_url" value="{{ streamer_config.stream_settings.rtmp_url }}">
            </div>
            <div class="settings-group">
                <h3>{{ _('Twitch Bot') }}</h3>
                <label>{{ _('Bot-Account Name:') }}</label>
                <input type="text" name="bot_nick" value="{{ streamer_config.twitch_bot.bot_nick }}">
                <label>{{ _('Bot-Account OAuth-Token:') }}</label>
                <input type="password" name="bot_token" placeholder="{{ _('Wird nicht angezeigt, kann aber überschrieben werden') }}">
                <label>{{ _('Kanal, dem der Bot beitritt:') }}</label>
                <input type="text" name="channel_nick" value="{{ streamer_config.twitch_bot.channel_nick }}">
            </div>
				<div class="settings-group">
					<h3>{{ _('Konfigurations-Presets') }}</h3>
					<label>{{ _('Gespeichertes Preset laden / löschen:') }}</label>
					<div style="display: flex; gap: 10px; margin-bottom: 15px;">
						<select id="preset-to-load-select" name="preset_to_load" style="width: 100%;">
							<option value="">-- {{ _('Preset auswählen') }} --</option>
							{% for name in config_presets.keys() %}
							<option value="{{ name }}">{{ name }}</option>
							{% endfor %}
						</select>
						<button type="button" 
								data-alert-select="{{ _('Bitte wähle ein Preset zum Laden aus.') }}"
								data-alert-success="{{ _('Preset erfolgreich geladen! Die Seite wird neu geladen.') }}"
								data-alert-error="{{ _('Fehler beim Laden des Presets:') }}"
								onclick="loadPreset(this)">
							{{ _('Laden') }}
						</button>
						<button type="button" 
								data-alert-select="{{ _('Bitte wähle ein Preset zum Löschen aus.') }}"
								data-confirm-tpl="{{ _('Bist du sicher, dass du das Preset \"%s\" permanent löschen möchtest?') }}"
								data-alert-success="{{ _('Preset erfolgreich gelöscht! Die Seite wird neu geladen.') }}"
								data-alert-error="{{ _('Fehler beim Löschen des Presets:') }}"
								onclick="deletePreset(this)" style="background-color: #c82333;">
							X
						</button>
					</div>
					<label>{{ _('Aktuelle Konfiguration als Preset speichern:') }}</label>
					<div style="display: flex; gap: 10px;">
						<input type="text" id="preset-name-input" name="preset_name" placeholder="{{ _('Name für das Preset...') }}" style="width: 100%;">
						<button type="button"
								data-alert-enter-name="{{ _('Bitte gib einen Namen für das Preset ein.') }}"
								data-alert-success="{{ _('Preset erfolgreich gespeichert! Die Seite wird neu geladen.') }}"
								data-alert-error="{{ _('Fehler beim Speichern des Presets:') }}"
								onclick="savePreset(this)" style="background-color: #52c41a;">
							{{ _('Speichern') }}
						</button>
					</div>
				</div>

        <div class="settings-grid">
            <fieldset id="overlay-fieldset">
                <div class="settings-group">
                    <h3>{{ _('Design (Overlay)') }}</h3>
                    <label>{{ _('Schriftart für "Now Playing"-Text:') }}</label>
                    <select name="ffmpeg_font_file" id="font-select">
                        <option value="" {% if not streamer_config.ffmpeg.font_file %}selected{% endif %}>-- {{ _('Overlay deaktiviert') }} --</option>
                        {% for font in fonts %}
                        <option value="{{ font }}" {% if streamer_config.ffmpeg.font_file == font %}selected{% endif %}>{{ font }}</option>
                        {% endfor %}
                    </select>
                    <div class="settings-grid" style="grid-template-columns: 1fr 1fr; margin-top: 15px;">
                        <div>
                            <label>{{ _('Schriftfarbe:') }}</label>
                            <input type="color" name="ffmpeg_font_color" value="{{ streamer_config.ffmpeg.font_color or '#FFFFFF' }}">
                        </div>
                        <div>
                            <label>{{ _('Box-Farbe:') }}</label>
                            <input type="color" name="ffmpeg_box_color" value="{{ streamer_config.ffmpeg.box_color or '#000000' }}">
                        </div>
                    </div>
                    <label style="margin-top: 10px;">{{ _('Box-Transparenz:') }} <span id="alpha-value">{{ streamer_config.ffmpeg.box_alpha or '0.5' }}</span></label>
                    <input type="range" name="ffmpeg_box_alpha" min="0.0" max="1.0" step="0.1" value="{{ streamer_config.ffmpeg.box_alpha or '0.5' }}" oninput="document.getElementById('alpha-value').textContent = this.value;">
                    <label style="margin-top: 10px;">{{ _('Text-Position:') }}</label>
                    <select name="ffmpeg_font_position">
                        <option value="bottom_center" {% if streamer_config.ffmpeg.font_position == 'bottom_center' %}selected{% endif %}>{{ _('Unten Mitte') }}</option>
                        <option value="top_center" {% if streamer_config.ffmpeg.font_position == 'top_center' %}selected{% endif %}>{{ _('Oben Mitte') }}</option>
                    </select>
                    <label style="margin-top: 10px;">{{ _('Schriftgröße:') }}</label>
                    <input type="number" name="ffmpeg_font_size" value="{{ streamer_config.ffmpeg.font_size or 24 }}" min="10" step="1">
                    <hr style="margin: 20px 0;">
                    <h4>{{ _('Schriftarten verwalten') }}</h4>
						<div id="font-list" style="max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-bottom: 10px;">
							{% for font in fonts %}
							<div style="display: flex; justify-content: space-between; align-items: center; padding: 5px;">
								<span>{{ font }}</span>
								<input type="hidden" name="font_name_to_delete" value="{{ font }}">
								<button type="submit" formaction="/delete_font" formmethod="post"
										data-confirm-msg="{{ _('Soll die Schriftart %(font)s wirklich gelöscht werden?', font=font) }}"
										onclick="if(!confirm(this.dataset.confirmMsg)) return false;"
										style="background: #c82333; padding: 2px 8px; font-size: 12px;">
									X
								</button>
							</div>
							{% else %}
							<p>{{ _('Keine Schriftarten gefunden.') }}</p>
							{% endfor %}
						</div>
                    
                    <label>{{ _('Neue Schriftart hochladen (.ttf, .otf):') }}</label>
<div style="display: flex; gap: 10px;">
    <input type="file" name="font_file" accept=".ttf,.otf">
    <button type="submit" formaction="/upload_font" formmethod="post" enctype="multipart/form-data">{{ _('Hochladen') }}</button>
</div>
</div>
</fieldset>
                    
                </div>
            </fieldset>

            <div class="settings-group">
				
                <h3>FFmpeg</h3>
				<div>
                    <label>{{ _('Automatischer Neustart (Feste Uhrzeit)') }}</label>
                    <input type="time" name="auto_restart_time" 
                           value="{{ streamer_config.ffmpeg.auto_restart_time or '' }}">
                    <small>{{ _('Erzwingt jeden Tag zu dieser Uhrzeit einen Neustart. (z.B. 04:00). Leer lassen, um zu deaktivieren.') }}</small>
                </div>
				<div>
                    <label>{{ _('Automatischer Neustart (Stunden)') }}</label>
                    <input type="number" name="auto_restart_interval_hours" 
                           value="{{ streamer_config.ffmpeg.auto_restart_interval_hours or 24 }}" 
                           min="0">
                    <small>{{ _('Erzwingt alle X Stunden einen Neustart des Streams (um 48h-Disconnects zu umgehen). 0 = Deaktiviert.') }}</small>
                </div>
                <label>{{ _('Stream-Modus:') }}</label>
                <div class="radio-option">
                    <input type="radio" id="mode_transcode" name="ffmpeg_stream_mode" value="transcode" {% if streamer_config.ffmpeg.stream_mode == 'transcode' or not streamer_config.ffmpeg.stream_mode %}checked{% endif %}>
                    <label for="mode_transcode">{{ _('Transcoding (Flexibel, hohe CPU-Last)') }}</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="mode_remux" name="ffmpeg_stream_mode" value="remux" {% if streamer_config.ffmpeg.stream_mode == 'remux' %}checked{% endif %}>
                    <label for="mode_remux">{{ _('Remuxing / Copy (CPU-schonend, strenge Regeln)') }}</label>
                </div>
                <div id="remux-warning" class="warning-box">
                    <strong>⚠️ {{ _('Achtung!') }}</strong> {{ _('Im "Remuxing"-Modus müssen ALLE deine Videodateien exakt die gleichen Eigenschaften haben.') }}
                </div>
                <hr>
                <div id="transcode-settings">
                    <label>{{ _('Encoder (nur für Transcoding-Modus):') }}</label>
                    <select name="ffmpeg_encoder" class="transcode-only">
                        <option value="libx264" {% if streamer_config.ffmpeg.encoder == 'libx264' %}selected{% endif %}>{{ _('libx264 (CPU, hohe Qualität)') }}</option>
                        <option value="h264_nvenc" {% if streamer_config.ffmpeg.encoder == 'h264_nvenc' %}selected{% endif %}>{{ _('h264_nvenc (NVIDIA GPU, schnell)') }}</option>
                        <option value="h264_qsv" {% if streamer_config.ffmpeg.encoder == 'h264_qsv' %}selected{% endif %}>{{ _('h264_qsv (Intel Quick Sync, sehr schnell)') }}</option>
                        <option value="h264_amf" {% if streamer_config.ffmpeg.encoder == 'h264_amf' %}selected{% endif %}>{{ _('h264_amf (AMD GPU, sehr schnell)') }}</option>
                    </select>
                    <label>{{ _('Video Bitrate (z.B. 6000k):') }}</label>
                    <input type="text" name="ffmpeg_video_bitrate" value="{{ streamer_config.ffmpeg.video_bitrate }}" class="transcode-only">
                    <label>{{ _('Audio Bitrate (z.B. 160k):') }}</label>
                    <input type="text" name="ffmpeg_audio_bitrate" value="{{ streamer_config.ffmpeg.audio_bitrate }}" class="transcode-only">
                    <label>{{ _('Preset (für libx264 Encoder):') }}</label>
                    <select name="ffmpeg_preset" class="transcode-only">
                        <option value="ultrafast" {% if streamer_config.ffmpeg.preset == 'ultrafast' %}selected{% endif %}>Ultrafast</option>
                        <option value="veryfast" {% if streamer_config.ffmpeg.preset == 'veryfast' %}selected{% endif %}>Veryfast</option>
                        <option value="medium" {% if streamer_config.ffmpeg.preset == 'medium' %}selected{% endif %}>Medium</option>
                    </select>
                    <label>{{ _('Auflösung (z.B. 1920x1080):') }}</label>
                    <input type="text" name="ffmpeg_resolution" value="{{ streamer_config.ffmpeg.resolution }}" class="transcode-only">
                    <label>{{ _('Framerate (z.B. 60):') }}</label>
                    <input type="text" name="ffmpeg_framerate" value="{{ streamer_config.ffmpeg.framerate }}" class="transcode-only">
                </div>
            </div>
        </div>

			<div style="display: flex; flex-wrap: wrap; align-items: center; gap: 15px; margin-top: 20px;">
				<div>
					<button type="button" onclick="saveSettings('save')" style="background-color: #28a745;">
						{{ _('Speichern (ohne Neustart)') }}
					</button>
				</div>
				<div style="border-left: 2px solid #ddd; height: 40px; margin: 0 5px;"></div>
				<div>
					<button type="button"
							data-confirm-msg="{{ _('Sichert die Einstellungen und startet den Stream nach dem aktuellen Video neu, damit sie wirksam werden. Sicher?') }}"
							onclick="if(confirm(this.dataset.confirmMsg)) saveSettings('save_soft');">
						{{ _('Speichern & Sanft Neustarten') }}
					</button>
					<button type="button"
							data-confirm-msg="{{ _('WARNUNG: Sichert die Einstellungen und startet den Stream sofort neu. Dies führt zu einer kurzen Unterbrechung. Sicher?') }}"
							onclick="if(confirm(this.dataset.confirmMsg)) saveSettings('save_hard');"
							style="background-color: #dc3545;">
						{{ _('Speichern & Sofort Neustarten') }}
					</button>
				</div>
			</div>
			</form>
			</div>

<div id="manager_config" class="tab-content {% if active_tab == 'manager_config' %}active{% endif %}">
            <h2>{{ _('Manager Konfiguration (`manager_config.json`)') }}</h2>
            <form action="/save_manager_config" method="post">
                <div class="settings-group">
                    <h3>{{ _('Globale Einstellungen') }}</h3>
					<div class="settings-grid" style="grid-template-columns: 1fr 1fr; margin-top: 15px;">
					<div>
						<label for="language">{{ _('Sprache der Benutzeroberfläche:') }}</label>
						<select id="language" name="language" onchange="this.form.submit()">
							<option value="de" {% if manager_config.language == 'de' %}selected{% endif %}>{{ _('Deutsch') }}</option>
							<option value="en" {% if manager_config.language == 'en' %}selected{% endif %}>{{ _('English') }}</option>
						</select>
					</div>
				</div>
                    <div class="settings-grid" style="grid-template-columns: 1fr 1fr;">
                        <div>
                            <label for="title_prefix">{{ _('Titel-Prefix (für Twitch):') }}</label>
                            <input type="text" id="title_prefix" name="title_prefix" value="{{ manager_config.title_prefix }}">
                        </div>
                        <div>
                            <label for="overlay_prefix">{{ _('Overlay-Prefix (für "Now Playing"):') }}</label>
                            <input type="text" id="overlay_prefix" name="overlay_prefix" value="{{ manager_config.overlay_prefix }}">
                        </div>
                    </div>
                    <div class="settings-grid" style="grid-template-columns: 1fr 1fr; margin-top: 15px;">
                         <div>
                            <label for="language">{{ _('Stream-Sprache:') }}</label>
                            <select id="language" name="language">
                                <option value="de" {% if manager_config.language == 'de' %}selected{% endif %}>{{ _('Deutsch') }}</option>
                                <option value="en" {% if manager_config.language == 'en' %}selected{% endif %}>{{ _('English') }}</option>
                            </select>
                        </div>
                    </div>
                    <label for="video_directories" style="margin-top: 15px;">{{ _('Video-Ordner (ein Pfad pro Zeile):') }}</label>
                    <textarea id="video_directories" name="video_directories" rows="4" style="width: 100%; font-family: inherit;">{{ manager_config.video_directories | join('\n') }}</textarea>
                </div>
                <div class="settings-group">
                    <h3>{{ _('Thumbnail-Einstellungen') }}</h3>
                    <label for="thumbnail_scale">{{ _('Thumbnail Skalierung (FFmpeg-Format):') }}</label>
                    <input type="text" id="thumbnail_scale" name="thumbnail_scale" value="{{ manager_config.thumbnail_scale }}">
                    <small>{{ _('Beispiele: `320:-1` (320px breit), `-1:180` (180px hoch), `320:180` (feste Größe)') }}</small>
                </div>
                <br>
                <button type="submit">{{ _('Manager-Einstellungen speichern') }}</button>
            </form>
        </div>
		
		<div id="process" class="tab-content {% if active_tab == 'process' %}active{% endif %}">
            <h2>{{ _('Streamer Prozess-Steuerung') }}</h2>
            <div class="process-controls">
                {% if streamer_is_running %}
                    <div class="status-indicator">
                        <span style="color: green; font-weight: bold;">✔ {{ _('Streamer-Prozess läuft') }}</span>
						<form action="/stop_streamer" method="post" style="margin: 0;">
							<button type="submit" style="background-color: #dc3545;"
									data-confirm-msg="{{ _('Bist du sicher, dass du den Streamer-Prozess beenden möchtest?') }}"
									onclick="if(!confirm(this.dataset.confirmMsg)) return false;">
								{{ _('Streamer Stoppen') }}
							</button>
						</form>
                    </div>
                {% else %}
                    <div class="status-indicator">
                        <span style="color: red; font-weight: bold;">✖ {{ _('Streamer-Prozess ist offline') }}</span>
                        <form action="/start_streamer" method="post" style="margin: 0;">
                            <button type="submit" style="background-color: #28a745;">{{ _('Streamer Starten') }}</button>
                        </form>
                    </div>
                {% endif %}
            </div>
            <h3>{{ _('Live-Log (`streamer.log`)') }}</h3>
            <pre id="log-output">{{ _('Log-Daten werden geladen...') }}</pre>
			<h3 style="margin-top: 20px;">{{ _('FFmpeg Live-Log (`ffmpeg.log`)') }}</h3>
            <pre id="ffmpeg-log-output" style="color: #a9a9a9;">{{ _('FFmpeg-Log wird geladen...') }}</pre>
        </div>
    
    
</div>
    <div id="thumbnail-modal" class="modal" onclick="closeModal()">
        <span class="modal-close">&times;</span>
        <img class="modal-content" id="modal-img">
    </div>


<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        // --- GLOBALE VARIABLEN ---
        let logInterval = null;

        // --- GLOBALE FUNKTIONEN ---

function loadPreset(button) {
            const select = document.getElementById('preset-to-load-select');
            const presetName = select.value;
            if (!presetName) {
                alert(button.dataset.alertSelect);
                return;
            }
            const formData = new FormData();
            formData.append('preset_to_load', presetName);
            fetch('/load_config_preset', { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(button.dataset.alertSuccess);
                        window.location.reload();
                    } else {
                        alert(button.dataset.alertError + ' ' + data.error);
                    }
                })
                .catch(error => console.error('Fehler:', error));
        }

        function savePreset(button) {
            const input = document.getElementById('preset-name-input');
            const presetName = input.value;
            if (!presetName || presetName.trim() === '') {
                alert(button.dataset.alertEnterName);
                return;
            }
            const form = document.querySelector('form[action="/save_settings"]');
            const formData = new FormData(form);
            formData.append('preset_name', presetName);
            fetch('/save_config_preset', { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(button.dataset.alertSuccess);
                        window.location.reload();
                    } else {
                        alert(button.dataset.alertError + ' ' + data.error);
                    }
                })
                .catch(error => console.error('Fehler:', error));
        }

        function deletePreset(button) {
            const select = document.getElementById('preset-to-load-select');
            const presetName = select.value;
            if (!presetName) {
                alert(button.dataset.alertSelect);
                return;
            }
            if (confirm(button.dataset.confirmTpl.replace('%s', presetName))) {
                const formData = new FormData();
                formData.append('preset_to_delete', presetName);
                fetch('/delete_config_preset', { method: 'POST', body: formData })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(button.dataset.alertSuccess);
                            window.location.reload();
                        } else {
                            alert(button.dataset.alertError + ' ' + data.error);
                        }
                    })
                    .catch(error => console.error('Fehler:', error));
            }
        }

function saveSettings(action) {
            const form = document.querySelector('form[action="/save_settings"]');
            const formData = new FormData(form);
            formData.append('action', action);
            fetch('/save_settings_js', { method: 'POST', body: formData })
                .then(response => { window.location.reload(); })
                .catch(error => {
                    console.error('Fehler beim Speichern:', error);
                    alert(form.dataset.alertSaveError); // KORRIGIERT: Greift jetzt auf das data-Attribut des Formulars zu
                });
        }

        function updateUiForStreamMode() {
            // --- KEINE ÄNDERUNG NÖTIG ---
            const remuxRadio = document.getElementById('mode_remux');
            const overlayFieldset = document.getElementById('overlay-fieldset');
            const transcodeOnlyElements = document.querySelectorAll('.transcode-only');
            const fontSelect = document.getElementById('font-select');
            const remuxWarning = document.getElementById('remux-warning');
            if (!remuxRadio || !overlayFieldset) return;
            const isRemux = remuxRadio.checked;
            overlayFieldset.disabled = isRemux;
            transcodeOnlyElements.forEach(el => el.disabled = isRemux);
            if (isRemux) {
                fontSelect.value = "";
                remuxWarning.style.display = 'block';
            } else {
                remuxWarning.style.display = 'none';
            }
        }

        function handleFontChange() {
            // --- KEINE ÄNDERUNG NÖTIG ---
            const fontSelect = document.getElementById('font-select');
            const transcodeRadio = document.getElementById('mode_transcode');
            if (fontSelect.value !== "") {
                transcodeRadio.checked = true;
                updateUiForStreamMode();
            }
        }

        function handleActionTypeChange() {
            // --- KEINE ÄNDERUNG NÖTIG ---
            const select = document.getElementById('action-type-select');
            const selectedType = select.value;
            document.querySelectorAll('.action-params').forEach(div => {
                div.style.display = 'none';
            });
            const targetDiv = document.getElementById('params-' + selectedType);
            if (targetDiv) {
                targetDiv.style.display = 'block';
            }
        }

        function saveRotation(button) {
            // --- KEINE ÄNDERUNG NÖTIG ---
            const rotationName = document.getElementById('rotation-name-input').value;
            if (!rotationName || rotationName.trim() === "") {
                alert(button.dataset.alertEnterName);
                return;
            }
            const rotationContainer = document.getElementById('rotation-sequence');
            const items = rotationContainer.querySelectorAll('.rotation-item');
            const playlistIds = [];
            items.forEach(item => {
                playlistIds.push(item.dataset.id);
            });
            if (playlistIds.length === 0) {
                alert(button.dataset.alertEmpty);
                return;
            }
            document.getElementById('rotation-name').value = rotationName;
            document.getElementById('rotation-playlist-ids').value = JSON.stringify(playlistIds);
            document.getElementById('rotation-form').submit();
        }

        function openTab(evt, tabName) {
            // --- KEINE ÄNDERUNG NÖTIG ---
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            history.pushState(null, '', '?active_tab=' + tabName);
            clearInterval(logInterval);

            if (tabName === 'process') {
                updateScriptLog();
                updateFfmpegLog();
                logInterval = setInterval(() => {
                    updateScriptLog();
                    updateFfmpegLog();
                }, 2000);
            } else if (tabName === 'bot') {
                updateBotLogs();
                logInterval = setInterval(updateBotLogs, 2000);
            }
        }

function updateBotLogs() {
            const botLogOutput = document.getElementById('bot-log-output');
            const chatLogOutput = document.getElementById('chat-log-output');
            fetch('/get_bot_log_content?_=' + new Date().getTime()).then(response => response.json()).then(data => {
                if (botLogOutput && botLogOutput.textContent !== data.log_content) {
                    botLogOutput.textContent = data.log_content;
                    botLogOutput.scrollTop = botLogOutput.scrollHeight;
                }
            });
            fetch('/get_chat_log_content?_=' + new Date().getTime()).then(response => response.json()).then(data => {
                if (chatLogOutput && chatLogOutput.textContent !== data.log_content) {
                    chatLogOutput.textContent = data.log_content;
                    chatLogOutput.scrollTop = chatLogOutput.scrollHeight;
                }
            });
        }

        function updateStatus() {
            const statusBox = document.querySelector('.status-box'); // Get the parent div
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const statusEl = document.getElementById('status-text');
                    const botStatusEl = document.getElementById('bot-status-text');
                    const npEl = document.getElementById('status-np');
                    const barFillEl = document.getElementById('progress-bar-fill');
                    const progressTextEl = document.getElementById('progress-text');
                    const progressBarContainer = document.querySelector('.progress-bar-container');
                    
                    // The server already sends translated values for status, bot_status, and now_playing
                    statusEl.textContent = data.status;
                    botStatusEl.textContent = data.bot_status;
                    npEl.textContent = data.now_playing;
                    
                    // The color logic remains the same, but compares against the original English values
                    if (data.status_raw === 'Online') { statusEl.style.color = 'green'; }
                    else if (data.status_raw === 'Offline') { statusEl.style.color = 'red'; }
                    else { statusEl.style.color = 'orange'; }

                    if (data.bot_status_raw === 'Online') { botStatusEl.style.color = 'green'; }
                    else if (data.bot_status_raw === 'Offline') { botStatusEl.style.color = 'red'; }
                    else { botStatusEl.style.color = 'orange'; }

                    if (data.status_raw === 'Online' && data.video_duration > 0) {
                        const elapsed = Math.max(0, data.video_elapsed);
                        const duration = data.video_duration;
                        const percent = Math.min(100, (elapsed / duration) * 100);
                        if (barFillEl) barFillEl.style.width = percent + '%';
                        if (progressTextEl) progressTextEl.textContent = `${formatTime(elapsed)} / ${formatTime(duration)}`;
                        if (progressBarContainer) progressBarContainer.style.display = 'block';
                    } else {
                        if (progressBarContainer) progressBarContainer.style.display = 'none';
                    }
                })
                .catch(() => {
                    const errorMsg = statusBox.dataset.fetchError || 'Error';
                    document.getElementById('status-text').textContent = errorMsg;
                    document.getElementById('status-text').style.color = 'red';
                    document.getElementById('bot-status-text').textContent = errorMsg;
                    document.getElementById('bot-status-text').style.color = 'red';
                });
        }

			function formatTime(seconds) {
				if (isNaN(seconds) || seconds < 0) return "00:00:00";
				const date = new Date(null);
				date.setSeconds(seconds);
				// KORREKTUR: Extrahiert HH:MM:SS statt nur MM:SS
				return date.toISOString().substr(11, 8);
			}

        function promptToRename(button, videoId, currentBasename) {
            const currentNameWithoutExt = currentBasename.substring(0, currentBasename.lastIndexOf('.')) || currentBasename;
            const newName = prompt(button.dataset.promptMessage, currentNameWithoutExt);
            if (newName && newName.trim() !== "" && newName !== currentNameWithoutExt) {
                document.getElementById('rename-video-id').value = videoId;
                document.getElementById('rename-new-name').value = newName;
                document.getElementById('rename-form').submit();
            }
        }

        function sortPlaylist() {
            // This function contains no user-facing text and remains unchanged
            const sortBy = document.getElementById('sort-playlist-by').value;
            const playlistContainer = document.getElementById('playlist-items');
            const items = Array.from(playlistContainer.querySelectorAll('.video-item'));
            items.sort((a, b) => {
                let valA, valB;
                if (sortBy === 'basename') { valA = a.querySelector('.video-name').textContent.toLowerCase(); valB = b.querySelector('.video-name').textContent.toLowerCase(); }
                else if (sortBy === 'title') { valA = a.querySelector('input[name="title"]').value.toLowerCase(); valB = b.querySelector('input[name="title"]').value.toLowerCase(); }
                else if (sortBy === 'game') { valA = a.querySelector('input[name="game"]').value.toLowerCase(); valB = b.querySelector('input[name="game"]').value.toLowerCase(); }
                if (valA < valB) return -1;
                if (valA > valB) return 1;
                return 0;
            });
            items.forEach(item => playlistContainer.appendChild(item));
        }

        function sortTable(columnIndex, tableId) {
            // This function contains no user-facing text and remains unchanged
            const table = document.getElementById(tableId);
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.rows);
            const currentDir = table.dataset.sortDirection || 'asc';
            const clickedColumn = columnIndex.toString();
            let newDir = 'asc';
            if (table.dataset.sortColumn === clickedColumn && currentDir === 'asc') { newDir = 'desc'; }
            table.dataset.sortColumn = clickedColumn;
            table.dataset.sortDirection = newDir;
            rows.sort((a, b) => {
                const x = a.cells[columnIndex].textContent.toLowerCase();
                const y = b.cells[columnIndex].textContent.toLowerCase();
                if (x < y) return newDir === 'asc' ? -1 : 1;
                if (x > y) return newDir === 'asc' ? 1 : -1;
                return 0;
            });
            rows.forEach(row => tbody.appendChild(row));
            const headers = table.tHead.rows[0].cells;
            for (let i = 0; i < headers.length; i++) {
                const arrowSpan = headers[i].querySelector('.sort-arrow');
                if (arrowSpan) {
                    if (i.toString() === clickedColumn) { arrowSpan.innerHTML = newDir === 'asc' ? '&nbsp;▲' : '&nbsp;▼'; }
                    else { arrowSpan.innerHTML = ''; }
                }
            }
        }

        function toggleScheduleInputs(selectElement) {
            const parent = selectElement.parentElement;
            const timeInput = parent.querySelector('.schedule-input-time');
            const repeatInput = parent.querySelector('.schedule-input-repeat');
            if (selectElement.value === 'time') {
                timeInput.style.display = 'block';
                repeatInput.style.display = 'none';
            } else {
                timeInput.style.display = 'none';
                repeatInput.style.display = 'block';
            }
        }

		function updateScriptLog() {
            fetch('/get_log_content?_=' + new Date().getTime()).then(response => response.json()).then(data => {
                const logOutput = document.getElementById('log-output');
                if (logOutput && logOutput.textContent !== data.log_content) {
                    logOutput.textContent = data.log_content;
                    logOutput.scrollTop = logOutput.scrollHeight;
                }
            });
        }

        function updateFfmpegLog() {
            fetch('/get_ffmpeg_log_content?_=' + new Date().getTime()).then(response => response.json()).then(data => {
                const logOutput = document.getElementById('ffmpeg-log-output');
                if (logOutput && logOutput.textContent !== data.log_content) {
                    logOutput.textContent = data.log_content;
                    logOutput.scrollTop = logOutput.scrollHeight;
                }
            });
        }

        function bulkSetStatus(enable) {
            const checkboxes = document.querySelectorAll('#playlist-items .video-item:not([style*="display: none"]) input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = enable;
                checkbox.closest('.video-item').classList.toggle('disabled', !enable);
            });
        }

        function filterLibrary() {
            const input = document.getElementById('library-search-box');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('library-table');
            const tr = table.getElementsByTagName('tr');
            for (let i = 1; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName('td')[1];
                if (td) {
                    let txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) { tr[i].style.display = ""; }
                    else { tr[i].style.display = "none"; }
                }
            }
        }

        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('#library-table tbody tr:not([style*="display: none"]) input[type="checkbox"]');
            checkboxes.forEach(checkbox => { checkbox.checked = source.checked; });
        }

        function filterPlaylist() {
            const input = document.getElementById('search-box');
            const filter = input.value.toUpperCase();
            const items = document.querySelectorAll('#playlist-items .video-item');
            items.forEach(item => {
                const name = item.querySelector('.video-name').textContent.toUpperCase();
                const title = item.querySelector('input[name="title"]').value.toUpperCase();
                const game = item.querySelector('input[name="game"]').value.toUpperCase();
                if (name.includes(filter) || title.includes(filter) || game.includes(filter)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function openModal(src) {
            const modal = document.getElementById('thumbnail-modal');
            const modalImg = document.getElementById('modal-img');
            modal.style.display = "block";
            modalImg.src = src;
        }

        function closeModal() {
            document.getElementById('thumbnail-modal').style.display = "none";
        }


// --- HAUPT-INITIALISIERUNG ---
document.addEventListener('DOMContentLoaded', function() {
            // Alle Initialisierungen, die sofort passieren können
            const actionTypeSelect = document.getElementById('action-type-select');
            if (actionTypeSelect) {
                actionTypeSelect.addEventListener('change', handleActionTypeChange);
                handleActionTypeChange();
            }
            updateUiForStreamMode();
            document.querySelectorAll('input[name="ffmpeg_stream_mode"]').forEach(radio => {
                radio.addEventListener('change', updateUiForStreamMode);
            });
            const fontSelect = document.getElementById('font-select');
            if (fontSelect) {
                fontSelect.addEventListener('change', handleFontChange);
            }

            updateStatus();
            setInterval(updateStatus, 1000);

            
// --- DIE LÖSUNG: Initialisiere Drag&Drop mit einer winzigen Verzögerung ---
setTimeout(function() {
    
    const playlistEl = document.getElementById('playlist-items');
    if (playlistEl) {
        new Sortable(playlistEl, {
            handle: '.drag-handle',
            animation: 150
        });
    }

    // 2. Drag & Drop für Rotationen (NEU)
    const availablePlaylistsEl = document.getElementById('available-playlists');
    const rotationSequenceEl = document.getElementById('rotation-sequence');

    if (availablePlaylistsEl && rotationSequenceEl) {
        
        new Sortable(availablePlaylistsEl, {
            group: 'rotations', 
            animation: 150
        });

        
        new Sortable(rotationSequenceEl, {
            group: 'rotations',
            animation: 150
        });
    }

    console.log("Drag & Drop wurde mit Verzögerung initialisiert.");
}, 100); // 100 Millisekunden Verzögerung
});
        
// NEUE, ROBUSTERE VERSION
function savePlaylistChanges(button) {
    const playlistItems = document.querySelectorAll('#playlist-items .video-item');
    const playlistData = [];
    
    // 1. Lese die Daten aus jedem Eintrag in der aktuellen DOM-Reihenfolge aus
    playlistItems.forEach(item => {
        const video_id = item.querySelector('input[name="video_id"]').value;
        const title = item.querySelector('input[name="title"]').value;
        const game = item.querySelector('input[name="game"]').value;
        const checkbox = item.querySelector('input[name="active_videos"]');
        
        playlistData.push({
            id: video_id,
            title: title,
            game: game,
            active: checkbox.checked
        });
    });

    const editingPlaylistId = document.querySelector('input[name="editing_playlist_id"]').value;

    // 2. Sende die gesammelten Daten als JSON an den Server
    fetch('/save_metadata', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            editing_playlist_id: editingPlaylistId,
            playlist_data: playlistData 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(button.dataset.alertError + ' ' + data.error);
        }
    })
    .catch(error => {
        console.error('Schwerwiegender Fehler:', error);
        alert(button.dataset.alertFatalError);
    });
}

function duplicateEntry(button, entryIndex, editingPlaylistId) {
    const formData = new FormData();
    formData.append('entry_index', entryIndex);
    formData.append('editing_playlist_id', editingPlaylistId);

    fetch('/duplicate_entry', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            alert(button.dataset.alertError);
        }
    });
}

function removeEntry(button, entryIndex, editingPlaylistId) {
    if (!confirm(button.dataset.confirmMsg)) {
        return;
    }
    const formData = new FormData();
    formData.append('entry_index', entryIndex); 
    formData.append('editing_playlist_id', editingPlaylistId);

    fetch('/remove_from_playlist', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            alert(button.dataset.alertError);
        }
    });
}
// --- NEU: Twitch Spiel-Suche ---

let gameSearchDebounceTimer;
let activeGameInput = null; // Das Feld, in das wir gerade tippen
let activeSuggestionIndex = -1;

// Debounce-Funktion, um API-Aufrufe beim Tippen zu verzögern
function debounce(func, delay) {
    clearTimeout(gameSearchDebounceTimer);
    gameSearchDebounceTimer = setTimeout(func, delay);
}

// Erstellt die Vorschlags-Box
function createSuggestionsBox(inputField, suggestions) {
    removeSuggestionsBox(); // Alte Box entfernen
    
    if (suggestions.length === 0) return;

    const box = document.createElement('div');
    box.className = 'autocomplete-suggestions';
    document.body.appendChild(box);

    // Positioniere die Box unter dem Eingabefeld
    const rect = inputField.getBoundingClientRect();
    box.style.left = rect.left + window.scrollX + 'px';
    box.style.top = rect.bottom + window.scrollY + 'px';
    box.style.width = rect.width + 'px';

    suggestions.forEach((suggestion, index) => {
        const div = document.createElement('div');
        div.className = 'autocomplete-suggestion';
        div.textContent = suggestion;
        
        // Klick-Event
        div.addEventListener('mousedown', (e) => {
            // mousedown statt click, damit es vor dem 'blur'-Event feuert
            e.preventDefault();
            inputField.value = suggestion;
            removeSuggestionsBox();
        });
        
        box.appendChild(div);
    });
}

// Entfernt die Vorschlags-Box
function removeSuggestionsBox() {
    const existingBox = document.querySelector('.autocomplete-suggestions');
    if (existingBox) {
        existingBox.remove();
    }
    activeSuggestionIndex = -1;
}

// Fragt die Server-API nach Spielen
function fetchGameSuggestions(query) {
    if (query.length < 2) {
        removeSuggestionsBox();
        return;
    }
    
    fetch(`/api/search_game?query=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (activeGameInput) { // Nur anzeigen, wenn das Feld noch aktiv ist
                createSuggestionsBox(activeGameInput, data);
            }
        })
        .catch(error => console.error('Fehler bei Spielsuche:', error));
}

// Event-Listener für Tastatur (Hoch/Runter/Enter)
function handleGameInputKeydown(e) {
    const box = document.querySelector('.autocomplete-suggestions');
    if (!box) return;

    const suggestions = box.querySelectorAll('.autocomplete-suggestion');
    if (suggestions.length === 0) return;

    if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeSuggestionIndex = (activeSuggestionIndex + 1) % suggestions.length;
        updateSuggestionHighlight(suggestions);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeSuggestionIndex = (activeSuggestionIndex - 1 + suggestions.length) % suggestions.length;
        updateSuggestionHighlight(suggestions);
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (activeSuggestionIndex > -1) {
            suggestions[activeSuggestionIndex].dispatchEvent(new Event('mousedown'));
        }
    } else if (e.key === 'Escape') {
        removeSuggestionsBox();
    }
}

// Hebt die aktive Auswahl hervor
function updateSuggestionHighlight(suggestions) {
    suggestions.forEach((s, i) => {
        s.classList.toggle('active', i === activeSuggestionIndex);
    });
}

// Event-Delegation: Wir binden die Events an den Playlist-Container
document.addEventListener('DOMContentLoaded', () => {
    const playlistContainer = document.getElementById('playlist-items');
    
    if (playlistContainer) {
        // Event wird ausgelöst, wenn man in ein 'game'-Feld TIPPTEST
        playlistContainer.addEventListener('input', (e) => {
            if (e.target && e.target.name === 'game') {
                activeGameInput = e.target; // Merken, welches Feld wir bearbeiten
                debounce(() => fetchGameSuggestions(e.target.value), 100); // 100ms warten
            }
        });
        
        // Event für Tastatur (Pfeiltasten/Enter)
        playlistContainer.addEventListener('keydown', (e) => {
            if (e.target && e.target.name === 'game') {
                handleGameInputKeydown(e);
            }
        });

        // Event wird ausgelöst, wenn man das Feld VERLÄSST
        playlistContainer.addEventListener('blur', (e) => {
            if (e.target && e.target.name === 'game') {
                // Kurze Verzögerung, damit ein Klick auf die Box noch funktioniert
                setTimeout(() => {
                    removeSuggestionsBox();
                    activeGameInput = null;
                }, 150);
            }
        }, true); // 'true' (Capture-Phase) ist wichtig für 'blur'
    }
});
// --- ENDE: Twitch Spiel-Suche ---
    </script>
</body>
