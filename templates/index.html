<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Stream Control Center</title>
    <style>
	:root {
    /* ... deine bestehenden Variablen ... */
    --twitch-purple: #9146FF;
    --twitch-purple-hover: #772ce8;
}
        {% for font in fonts %}
        @font-face {
            font-family: '{{ font }}';
            src: url('/fonts/{{ font }}');
        }
        {% endfor %}

        body { font-family: sans-serif; background-color: #f4f4f9; color: #333; margin: 20px; }
        h1, h2, h3 { color: #6441a5; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab-nav { border-bottom: 2px solid #ddd; display: flex; }
        .tab-button { background-color: #f0f0f0; border: 1px solid #ddd; border-bottom: none; border-radius: 5px 5px 0 0; padding: 15px 20px; font-size: 16px; cursor: pointer; color: #333; margin-right: 5px; position: relative; top: 1px; }
        .tab-button:hover { background-color: #e0e0e0; }
        .tab-button.active { background-color: #fff; border-bottom: 1px solid #fff; font-weight: bold; color: #6441a5; }
        .tab-content { display: none; padding-top: 20px; }
        .tab-content.active { display: block; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .settings-group { border: 2px solid #eee; padding: 15px; border-radius: 5px; background-color: #fafafa; }
        .settings-group h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        label { margin-bottom: 5px; font-weight: bold; font-size: 14px; display: block; }
        input[type="text"], input[type="password"], input[type="number"], select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        button { background-color: #6441a5; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; }
        button:hover { background-color: #523486; }
        .button-like { color: white; padding: 10px 20px; border-radius: 4px; font-size: 16px; }
        fieldset { border: none; padding: 0; margin: 0; }
		
		
        #library-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
		#library-table th, #library-table td { border-right: 1px solid #ddd; }
		#library-table th:last-child, #library-table td:last-child { border-right: none; }
		.sort-arrow { font-size: 0.6em; vertical-align: middle; }
        .video-item { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #ddd; gap: 10px; }
		.video-item.selected { background-color: #d6bfff !important; }
        .video-item.disabled { opacity: 0.5; }
        .video-item.disabled .drag-handle, .video-item.disabled .video-name { pointer-events: auto; }
        .video-item:nth-child(even) { background-color: #f9f9f9; }
        .drag-handle { cursor: grab; color: #999; font-size: 20px; flex-shrink: 0; }
        .thumbnail { width: 80px; height: 45px; object-fit: cover; border-radius: 3px; cursor: pointer; border: 1px solid #ddd; flex-shrink: 0; }
        .video-details { flex-grow: 1; flex-shrink: 1; min-width: 0; }
        .video-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-bottom: 5px; }
        .video-name:hover { overflow-x: auto; }
        .video-meta { font-size: 12px; color: #666; }
        .video-inputs { flex-shrink: 0; display: grid; grid-template-columns: 200px 150px; gap: 10px; }
        .delete-form { margin-left: auto; flex-shrink: 0; }
        .flash { padding: 10px; border-radius: 4px; margin-bottom: 20px; border: 1px solid transparent; }
        .flash.success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .flash.error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .flash.warning { background-color: #fff3cd; color: #856404; border-color: #ffeeba; }
        .flash.info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }
        .status-box { padding: 15px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px; }
		.progress-bar-container { width: 100%; background-color: #ddd; border-radius: 5px; margin-top: 10px; height: 20px; position: relative; }
        #progress-bar-fill { width: 0%; height: 100%; background-color: #6441a5; border-radius: 5px; transition: width 0.5s ease-in-out; }
        #progress-text { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; text-shadow: 1px 1px 2px black; }
        .playlist-controls { display: flex; padding: 10px; background: #fafafa; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8); }
        .modal-content { margin: auto; display: block; max-width: 80%; max-height: 80%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .modal-close { position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
		.process-controls { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        #log-output, #chat-log-output, #ffmpeg-log-output, #bot-log-output { background-color: #1e1e1e; font-family: Consolas, monospace; padding: 15px; border-radius: 5px; height: 300px; overflow-y: scroll; white-space: pre-wrap; word-wrap: break-word; }
        #log-output { color: #FFFFFF; }
        #ffmpeg-log-output { color: #FFFFFF; }
		#bot-log-output { color: #FFFFFF; }
		#chat-log-output { color: #FFFFFF; }
		.schedule-table { width: 100%; border-collapse: collapse; } .schedule-table th, .schedule-table td { border: 1px solid #ddd; padding: 8px; text-align: left; } .schedule-table th { background-color: #f2f2f2; }
        .event-inputs { display: flex; flex-direction: column; gap: 5px; }
        .rotation-list { border: 1px solid #ddd; padding: 10px; min-height: 400px; border-radius: 5px; background-color: #fafafa; }
		.rotation-item { padding: 8px 12px; margin-bottom: 5px; background-color: white; border: 1px solid #ccc; border-radius: 4px; cursor: grab; }
		.saved-rotation-item { display: flex; align-items: center; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; margin-bottom: 10px; }
   
		/* --- Stile für CTA & Navigations-Buttons --- */
		.cta-button { display: inline-block; background-color: var(--twitch-purple); color: white !important; padding: 15px 35px; border-radius: 8px; text-decoration: none; font-size: 1rem; font-weight: 600; transition: background-color 0.2s ease, transform 0.2s ease; border: none; cursor: pointer; }
		.cta-button:hover { background-color: var(--twitch-purple-hover); transform: translateY(-2px); }
		.nav-button { padding: 6px 12px !important; font-size: 0.85em !important; box-shadow: none !important; }
</style>

</head>
<body>
    <form id="rename-form" action="/rename_video" method="post" style="display: none;">
        <input type="hidden" name="video_id" id="rename-video-id">
        <input type="hidden" name="new_name" id="rename-new-name">
    </form>
    <form id="rotation-form" action="/save_rotation" method="post" style="display: none;">
        <input type="hidden" name="rotation_name" id="rotation-name">
        <input type="hidden" name="playlist_ids" id="rotation-playlist-ids">
    </form>

<div class="app-info-bar">
<h1>Stream Control Center</h1>
    <span>Version: <strong>{{ update_info.current_version }}</strong></span>
        {% if update_info and update_info.update_available %}
        <a href="https://hub.zeibig.me" target="_blank" class="update-link">Update verfügbar: {{ update_info.new_version }}!</a>
    {% endif %}
    <nav class="main-nav">
        <a href="https://hub.zeibig.me" target="_blank" class="cta-button nav-button">Stream-Control-Center Seite</a>
		<a href="https://zeibig.me" target="_blank" class="cta-button nav-button">Zeibig.me</a>
        <a href="https://hub.zeibig.me/anleitung.html" target="_blank" class="cta-button nav-button">Anleitung</a>
        <a href="https://github.com/Loip104/Stream-Control-Center/issues/new/choose" target="_blank" class="cta-button nav-button">Fehler melden</a>
        <a href="https://github.com/Loip104/Stream-Control-Center" target="_blank" class="cta-button nav-button">GitHub</a>
    </nav>

</div>

		<div class="status-box" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
					<div>
						<strong>Status:</strong> 
						Streamer: <span id="status-text" style="font-weight:bold;">Wird geladen...</span> | 
						Bot: <span id="bot-status-text" style="font-weight:bold;">Wird geladen...</span>
					</div>
					<div>
						<strong>Aktuell läuft:</strong> <span id="status-np">N/A</span>
					</div>
					<div>
						<form action="/skip_video" method="post" style="display: inline-block; margin: 0;">
							<button type="submit" title="Startet das nächste Video in der Playlist sofort." style="padding: 5px 10px; font-size: 14px;">Nächster Titel</button>
						</form>
						<form action="/restart_playlist" method="post" style="display: inline-block; margin: 0;">
							<button type="submit" title="Startet die aktuell laufende Playlist sofort von vorne." style="padding: 5px 10px; font-size: 14px;">Playlist Neustart</button>
						</form>
					</div>
					<div class="progress-bar-container" style="width: 100%; display: none;">
						<div id="progress-bar-fill"></div>
						<span id="progress-text">00:00 / 00:00</span>
					</div>
				</div>

        <div class="tab-nav">
            <button class="tab-button {% if active_tab == 'playlist' %}active{% endif %}" onclick="openTab(event, 'playlist')">Playlist</button>
            <button class="tab-button {% if active_tab == 'rotations' %}active{% endif %}" onclick="openTab(event, 'rotations')">Rotationen</button>
            <button class="tab-button {% if active_tab == 'library' %}active{% endif %}" onclick="openTab(event, 'library')">Bibliothek</button>
            <button class="tab-button {% if active_tab == 'schedule' %}active{% endif %}" onclick="openTab(event, 'schedule')">Sendeplan</button>
            <button class="tab-button {% if active_tab == 'process' %}active{% endif %}" onclick="openTab(event, 'process')">Prozess-Steuerung</button>
            <button class="tab-button {% if active_tab == 'settings' %}active{% endif %}" onclick="openTab(event, 'settings')">Streamer-Config</button>
            <button class="tab-button {% if active_tab == 'manager_config' %}active{% endif %}" onclick="openTab(event, 'manager_config')">Manager-Config</button>
			<button class="tab-button {% if active_tab == 'bot' %}active{% endif %}" onclick="openTab(event, 'bot')">Bot</button>
		</div>


                <div id="bot" class="tab-content {% if active_tab == 'bot' %}active{% endif %}">
		<hr style="margin-top: 20px;">
<h3>Befehls-Verwaltung</h3>
<div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; margin-bottom: 15px;">
    <table class="schedule-table">
        <thead>
            <tr>
                <th>Befehl</th>
                <th>Aktionstyp</th>
                <th>Details</th>
                <th>Berechtigung</th>
                <th>Bot-Antwort</th>
                <th>Aktion</th>
            </tr>
        </thead>
        <tbody>
            {% for command, details in bot_commands.items() %}
            <tr>
                <td><strong>{{ command }}</strong></td>
                <td>{{ details.action.type }}</td>
                <td>
                    {% if details.action.type == 'stream_control' %} Befehl: {{ details.action.command }}
                    {% elif details.action.type == 'chat_reply' %} Nachricht: {{ details.action.message }}
                    {% endif %}
                </td>
                <td>{{ details.permissions }}</td>
                <td style="font-family: monospace; font-size: 12px;">{{ details.response or '-' }}</td>
                <td>
                    <form action="/delete_bot_command" method="post" onsubmit="return confirm('Befehl {{ command }} wirklich löschen?');" style="margin: 0;">
                        <input type="hidden" name="command_name" value="{{ command }}">
                        <button type="submit" style="background: #c82333; padding: 2px 8px; font-size: 12px;">X</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="6" style="text-align: center;">Keine Befehle konfiguriert.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h4>Neuen Befehl hinzufügen</h4>
<form action="/add_bot_command" method="post" class="settings-group" style="padding: 15px;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: flex-end;">
        <div>
            <label>Befehl (z.B. !next)</label>
            <input type="text" name="command_name" required>
        </div>
        <div>
            <label>Berechtigung</label>
            <select name="permissions">
                <option value="everyone">Jeder</option>
                <option value="moderator">Moderatoren</option>
            </select>
        </div>
        <div>
            <label>Cooldown (Sekunden)</label>
            <input type="number" name="cooldown" value="10" min="0">
        </div>
        <div>
            <label>Aktionstyp</label>
            <select name="action_type" id="action-type-select">
                <option value="stream_control">Stream steuern</option>
                <option value="chat_reply">Chat-Antwort</option>
            </select>
        </div>
        
        <div id="params-stream_control" class="action-params">
            <label>Befehl an Streamer</label>
            <select name="stream_control_command">
                <option value="skip_track">Titel überspringen</option>
                <option value="restart_playlist">Playlist neustarten</option>
            </select>
        </div>

        <div id="params-chat_reply" class="action-params" style="display: none;">
            <label>Nachricht für Chat-Antwort</label>
            <input type="text" name="chat_reply_message" placeholder="Verwende {platzhalter}">
        </div>
    </div>
    <div style="margin-top: 10px;">
        <label>Antwort des Bots nach Aktion (optional)</label>
        <input type="text" name="response" placeholder="@{user} wird durch den Namen des Nutzers ersetzt.">
    </div>
    <button type="submit" style="margin-top: 15px;">Befehl hinzufügen</button>
</form>
            <h2>Bot Prozess-Steuerung</h2>
			<h3 style="margin-top: 20px;">Live Chat</h3>
			<pre id="chat-log-output" style="height: 400px; color: #d4d4d4;"></pre>
            <div class="process-controls">
                {% if bot_is_running %}
                    <div class="status-indicator">
                        <span style="color: green; font-weight: bold;">✔ Bot-Prozess läuft</span>
                        <form action="/stop_bot" method="post" style="margin: 0;">
                            <button type="submit" style="background-color: #dc3545;" onclick="return confirm('Bist du sicher, dass du den Bot-Prozess beenden möchtest?');">Bot Stoppen</button>
                        </form>
                    </div>
                {% else %}
                    <div class="status-indicator">
                        <span style="color: red; font-weight: bold;">✖ Bot-Prozess ist offline</span>
                        <form action="/start_bot" method="post" style="margin: 0;">
                            <button type="submit" style="background-color: #28a745;">Bot Starten</button>
                        </form>
                    </div>
                {% endif %}
            </div>
			
			
            <h3>Live-Log (`bot.log`)</h3>
            <pre id="bot-log-output">Log-Daten werden geladen...</pre>
			

        </div>


<div id="playlist" class="tab-content {% if active_tab == 'playlist' %}active{% endif %}">
    
    <div class="playlist-controls" style="flex-direction: column; align-items: flex-start;">
        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center; flex-wrap: wrap; gap: 15px;">
            
            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                
                <form method="get" style="display: flex; align-items: center; gap: 10px;">
                    <label for="playlist-select-editor" style="margin-bottom: 0;">Playlist-Editor:</label>
                    <input type="hidden" name="active_tab" value="playlist">
                    <select name="edit_playlist" id="playlist-select-editor" onchange="this.form.submit()">
                        {% for pl_id, pl_info in playlists_db.items() %}
                            <option value="{{ pl_id }}" {% if pl_id == manager_config.editing_playlist_id %}selected{% endif %}>
                                {{ pl_info.name }}
                            </option>
                        {% endfor %}
                    </select>
                </form>

                <form action="/delete_playlist" method="post" onsubmit="return confirm('Sicher, dass du die ausgewählte Playlist und die .csv-Datei permanent löschen möchtest?');">
                    <input type="hidden" name="playlist_to_delete" value="{{ playlists_db.get(manager_config.editing_playlist_id, {}).get('filename', '') }}">
                    <button type="submit" style="background-color: #c82333;">Geladene Playlist löschen</button>
                </form>
            </div>

            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                <span>Gesamtdauer: <strong>{{ total_duration }}</strong></span>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <label for="sort-playlist-by" style="margin-bottom: 0; font-weight: normal;">Sortieren nach:</label>
                    <select id="sort-playlist-by" style="width: auto; margin-bottom: 0;">
                        <option value="basename">Dateiname</option>
                        <option value="title">Titel</option>
                        <option value="game">Spiel</option>
                    </select>
                    <button type="button" onclick="sortPlaylist()">Sortieren</button>
                </div>
                <button type="button" onclick="bulkSetStatus(true)">Alle aktivieren</button>
                <button type="button" onclick="bulkSetStatus(false)">Alle deaktivieren</button>
            </div>
        </div>

        <div style="background-color: #e6f7ff; border: 1px solid #91d5ff; padding: 10px; border-radius: 5px; margin-top: 15px; width: 100%; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <div>
                <strong>Für den Stream aktiv:</strong> 
                <span style="font-family: monospace; background: #f0f0f0; padding: 2px 5px; border-radius: 3px;">
                    {{ active_playlist_info.name if active_playlist_info else 'Keine' }}
                </span>
            </div>
            
            <form action="/switch_playlist" method="post" style="display: flex; gap: 10px;">
                <input type="hidden" name="playlist_to_activate" value="{{ playlists_db.get(manager_config.editing_playlist_id, {}).get('filename', '') }}">
                <button type="submit" name="restart_mode" value="soft" style="background-color: #52c41a;">
                    '{{ playlists_db.get(manager_config.editing_playlist_id, {}).get('name', '') }}' aktivieren (Sanft)
                </button>
                <button type="submit" name="restart_mode" value="hard" style="background-color: #faad14;">
                    '{{ playlists_db.get(manager_config.editing_playlist_id, {}).get('name', '') }}' aktivieren (Sofort)
                </button>
            </form>
        </div>
    </div>

    <input type="text" id="search-box" onkeyup="filterPlaylist()" placeholder="Playlist durchsuchen..." style="margin-top: 15px;">

    <form id="playlist-form" method="post" action="javascript:void(0);">
        <input type="hidden" name="editing_playlist_id" value="{{ manager_config.editing_playlist_id }}">
        
        <div id="playlist-items">
            {% for video in videos %}
            <div class="video-item {% if video.status == '0' %}disabled{% endif %}">
                <span class="drag-handle" title="Ziehen zum Neuanordnen">☰</span>
                
                <button type="button" 
                        onclick="duplicateEntry('{{ loop.index0 }}', '{{ manager_config.editing_playlist_id }}')" 
                        title="Diesen Eintrag duplizieren" 
                        style="border:none; background:gray; cursor:pointer; padding: 0 5px; font-size: 1.3em;">❐</button>

                <div class="status-toggle">
                    <input type="checkbox" name="active_videos" value="{{ video.id }}" {% if video.status == '1' %}checked{% endif %} onchange="this.closest('.video-item').classList.toggle('disabled', !this.checked);">
                </div>

                <img src="/thumbnail/{{ video.id }}" class="thumbnail" onclick="openModal(this.src)" onerror="this.style.display='none'">                
                <div class="video-details">
                    <div class="video-name" title="{{ video.filename }}">{{ video.basename }}</div>
                    <div class="video-meta">{{ video.duration_str }} | {{ video.size_str }}</div>
                </div>

                <div class="video-inputs">
                    <input type="hidden" name="video_id" value="{{ video.id }}">
                    <input type="text" name="title" value="{{ video.title }}" placeholder="Titel">
                    <input type="text" name="game" value="{{ video.game }}" placeholder="Spiel / Kategorie">
                </div>
                
                <div class="delete-form" style="display: flex; gap: 5px;">
                <button type="button" 
                        onclick="removeEntry('{{ loop.index0 }}', '{{ manager_config.editing_playlist_id }}')" 
                        title="Nur diesen Playlist-Eintrag entfernen" 
                        style="background-color: #6c757d;">X</button>
                </div>
            </div>
            {% endfor %}
        </div>
        <br>
        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 15px; margin-top: 10px;">
            <div>
                <button type="button" onclick="savePlaylistChanges()" style="background-color: #28a745;">Änderungen speichern</button>
            </div>
        </div>
    </form>
</div>

        <div id="rotations" class="tab-content {% if active_tab == 'rotations' %}active{% endif %}">
            <h2>Playlist-Rotationen</h2>
            <p>Erstelle eine Abfolge von Playlists, die zu einer großen Master-Playlist zusammengefügt werden. Ziehe Playlists von links nach rechts, um sie zur Rotation hinzuzufügen.</p>
            <div style="margin-bottom: 10px; display: flex; gap: 10px; align-items: center;">
                <input type="text" id="rotation-name-input" placeholder="Name der Rotation..." style="width: 300px; margin-bottom: 0;" value="{{ rotation_name_to_edit }}">
                <button type="button" onclick="saveRotation()">Speichern & Kompilieren</button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                <div>
                    <h4>Verfügbare Playlists</h4>
                    <div id="available-playlists" class="rotation-list">
                        {% for pl_id, pl_info in playlists_db.items() %}
                        <div class="rotation-item" data-id="{{ pl_id }}">{{ pl_info.name }}</div>
                        {% endfor %}
                    </div>
                </div>
                <div>
                    <h4>Rotations-Ablauf</h4>
                    <div id="rotation-sequence" class="rotation-list">
                        {% for item in rotation_to_edit %}
                        <div class="rotation-item" data-id="{{ item.id }}">{{ item.name }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <hr style="margin-top: 25px;">
            <h3 style="margin-top: 20px;">Gespeicherte Rotationen</h3>
            <div id="saved-rotations-list">
                {% if not rotations_db %}
                    <p>Noch keine Rotationen gespeichert.</p>
                {% else %}
                    {% for rot_id, rot_info in rotations_db.items() %}
                    <div class="saved-rotation-item">
                        <span><strong>{{ rot_info.name }}</strong> ({{ rot_info.playlist_ids|length }} Playlists)</span>
                        <div style="margin-left: auto; display: flex; gap: 10px;">
                            <a href="?active_tab=rotations&load_rotation={{ rot_id }}" class="button-like" style="background-color: #6c757d; text-decoration: none;">Bearbeiten</a>
                            <form action="/delete_rotation" method="post" style="display: inline-block; margin: 0;" onsubmit="return confirm('Bist du sicher, dass du die Rotation \'{{ rot_info.name }}\' permanent löschen möchtest?');">
                                <input type="hidden" name="rotation_id" value="{{ rot_id }}">
                                <button type="submit" style="background-color: #c82333;">Löschen</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <div id="library" class="tab-content {% if active_tab == 'library' %}active{% endif %}">
            <h2>Globale Video-Bibliothek</h2>
            <p>Hier siehst du alle Videos, die in deinen konfigurierten Ordnern gefunden wurden.</p>
            <div style="background-color: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                <h4>Analyse- & Verwaltungs-Werkzeuge</h4>
                <div style="display:flex; gap: 10px; flex-wrap: wrap;">
				<form action="/sync_library" method="post" style="display: inline-block;">
                        <button type="submit" style="background-color: #17a2b8;">Bibliothek synchronisieren</button>
                    </form>
                    <form action="/find_orphaned_videos" method="post" style="display: inline-block;">
                        <button type="submit">Ungenutzte Videos finden</button>
                    </form>
                    <form action="/import_new_videos" method="post" style="display: inline-block;">
                        <button type="submit">Neue Videos importieren</button>
                    </form>
                    <form action="/generate_thumbnails" method="post" style="display: inline-block;">
                        <button type="submit">Fehlende Thumbnails generieren</button>
                    </form>
                </div>
                {% if orphaned_videos_result is not none %}
                <div style="margin-top: 15px;">
                    <strong>Ergebnis der Analyse:</strong>
                    {% if orphaned_videos_result %}
                    <ul style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: white; list-style-type: none; margin:0;">
                        {% for video_path in orphaned_videos_result %}
                        <li style="font-family: monospace; font-size: 12px;">{{ video_path }}</li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p style="margin-bottom: 0;">Keine ungenutzten Videos gefunden. Alle Videodateien sind in mindestens einer Playlist enthalten.</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <form method="post">
                <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; align-items: flex-end;">
                    <div style="border-right: 2px solid #ddd; padding-right: 15px; display: flex; gap: 15px; align-items: flex-end;">
                        <div>
                            <label for="playlist-select-target" style="margin-bottom:0;">Auswahl hinzufügen zu:</label>
                            <select name="playlist_select_target" id="playlist-select-target" style="width:auto; margin-bottom: 0;">
                                {% for pl_id, pl_info in playlists_db.items() %}
                                    <option value="{{ pl_info.filename }}" {% if pl_id == manager_config.active_playlist_id %}selected{% endif %}>
                                        {{ pl_info.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <button type="submit" formaction="/add_to_playlist" style="background-color: #28a745;">Hinzufügen</button>
                        </div>
                        <div>
                            <label for="new_playlist_name_from_lib" style="margin-bottom:0;">Neue Playlist aus Auswahl erstellen:</label>
                            <input type="text" id="new_playlist_name_from_lib" name="new_playlist_name" placeholder="Name für neue Playlist..." style="width:auto; margin-bottom: 0;">
                            <button type="submit" formaction="/create_playlist_from_selection">Erstellen</button>
                        </div>
                    </div>
                    <div>
                        <label style="margin-bottom:0;">Ausgewählte Dateien:</label>
                        <button type="submit" 
                                formaction="/delete_files_from_library" 
                                style="background-color: #dc3545;" 
                                onclick="return confirm('WARNUNG:\n\nDie ausgewählten Videos werden permanent von der Festplatte gelöscht. Diese Aktion kann nicht rückgängig gemacht werden.\n\nFortfahren?');">
                            Permanent Löschen
                        </button>
                    </div>
                    <div style="margin-left: auto;">
                         <input type="text" id="library-search-box" onkeyup="filterLibrary()" placeholder="Bibliothek durchsuchen..." style="width:auto; margin-bottom: 0;">
                    </div>
                </div>
                <div style="max-height: 600px; overflow-y: auto; border: 1px solid #ddd;">
                    <table id="library-table" style="width: 100%; border-collapse: collapse;">
                        <thead style="position: sticky; top: 0; background-color: #f2f2f2;">
                            <tr>
                                <th style="padding: 8px;"><input type="checkbox" onclick="toggleAllCheckboxes(this)"></th>
                                <th style="padding: 8px; text-align: left; cursor: pointer;" onclick="sortTable(1, 'library-table')">Datei<span class="sort-arrow"></span></th>
                                <th style="padding: 8px; text-align: left; cursor: pointer;" onclick="sortTable(2, 'library-table')">In Playlists<span class="sort-arrow"></span></th>
                                <th style="padding: 8px; text-align: left; cursor: pointer;" onclick="sortTable(3, 'library-table')">Dauer<span class="sort-arrow"></span></th>
                                <th style="padding: 8px; text-align: left; cursor: pointer;" onclick="sortTable(4, 'library-table')">Größe<span class="sort-arrow"></span></th>
                                <th style="padding: 8px; text-align: left; cursor: pointer;" onclick="sortTable(5, 'library-table')">Pfad<span class="sort-arrow"></span></th>
                                <th style="padding: 8px; text-align: center;">Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for video in all_disk_videos %}
                            <tr>
                                <td style="padding: 8px; border-top: 1px solid #ddd; text-align: center;"><input type="checkbox" name="selected_videos" value="{{ video.id }}"></td>
                                <td style="padding: 8px; border-top: 1px solid #ddd;">{{ video.basename }}</td>
                                <td style="padding: 8px; border-top: 1px solid #ddd; font-size: 11px; color: #333;">
                                    {% if video_playlist_map.get(video.id) %}
                                        {{ video_playlist_map.get(video.id) | join(', ') }}
                                    {% else %}
                                        <span style="color: #999;">-</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 8px; border-top: 1px solid #ddd;">{{ video.duration_str }}</td>
                                <td style="padding: 8px; border-top: 1px solid #ddd;">{{ video.size_str }}</td>
                                <td style="padding: 8px; border-top: 1px solid #ddd; font-size: 12px; color: #666;" title="{{ video.path }}">{{ video.path }}</td>
                                <td style="padding: 8px; border-top: 1px solid #ddd; text-align: center;">
                                    <button type="button" 
                                            onclick="promptToRename('{{ video.id }}', '{{ video.basename }}')" 
                                            title="Video umbenennen" 
                                            style="padding: 2px 8px; font-size: 14px;">
                                        ✏️
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
        </div>

        <div id="schedule" class="tab-content {% if active_tab == 'schedule' %}active{% endif %}">
            <h2>Wöchentlicher Sendeplan</h2>
            <p>Leere Einträge werden ignoriert. Wenn für eine Zeit kein Event geplant ist, wird die "Default Playlist" aus der <code>schedule.json</code> verwendet.</p>
            <form action="/save_schedule" method="post">
                <div style="overflow-x: auto;">
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>Tag</th>
                            <th>Event 1</th>
                            <th>Event 2</th>
                            <th>Event 3</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'] %}
                        {% for day in days %}
                        <tr>
                            <td><strong>{{ day.capitalize() }}</strong></td>
                            {% for i in range(3) %}
                            <td>
                                <div class="event-inputs">
                                    <select name="{{day}}_playlist_{{i}}" style="margin-bottom: 5px;">
                                        <option value="">-- Keine Playlist --</option>
                                        {% set event = schedule.get(day, [])[i] if schedule.get(day, [])|length > i else {} %}
                                        {% for pl_id, pl_info in playlists_db.items() %}
                                            <option value="{{ pl_id }}" {% if pl_id == event.playlist %}selected{% endif %}>
                                                {{ pl_info.name }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    
                                    <div style="display: flex; gap: 5px; align-items: center;">
                                        <input type="time" name="{{day}}_start_time_{{i}}" value="{{ event.start_time or '' }}">
                                        <select name="{{day}}_mode_{{i}}" onchange="toggleScheduleInputs(this)">
                                            <option value="time" {% if event.mode == 'time' or not event.mode %}selected{% endif %}>bis</option>
                                            <option value="repeat" {% if event.mode == 'repeat' %}selected{% endif %}>x mal</option>
                                        </select>
                                        <input type="time" name="{{day}}_end_time_{{i}}" value="{{ event.end_time or '' }}" class="schedule-input-time" style="display: {% if event.mode == 'repeat' %}none{% else %}block{% endif %};">
                                        <input type="number" name="{{day}}_repeat_{{i}}" value="{{ event.repeat or 1 }}" min="1" class="schedule-input-repeat" style="width: 60px; display: {% if event.mode == 'repeat' %}block{% else %}none{% endif %};">
                                    </div>
                                </div>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
                <br>
                <button type="submit">Sendeplan speichern</button>
            </form>
        </div>
<div id="settings" class="tab-content {% if active_tab == 'settings' %}active{% endif %}">
    <h2>Streamer Konfiguration (`config.json`)</h2>
    <form action="/save_settings" method="post">
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 20px;">
            <div class="settings-group">
                <h3>Twitch API</h3>
                <label>Client-ID:</label>
                <input type="text" name="twitch_client_id" value="{{ streamer_config.twitch_api.client_id }}">
                <label>OAuth Token:</label>
                <input type="password" name="twitch_oauth_token" value="{{ streamer_config.twitch_api.oauth_token }}">
                <label>Kanalname:</label>
                <input type="text" name="twitch_channel_name" value="{{ streamer_config.twitch_api.channel_name }}">
            </div>

            <div class="settings-group">
                <h3>Stream</h3>
                <label>Stream Key:</label>
                <input type="password" name="stream_key" value="{{ streamer_config.stream_settings.stream_key }}">
                <label>RTMP URL ({STREAM_KEY} wird ersetzt):</label>
                <input type="text" name="rtmp_url" value="{{ streamer_config.stream_settings.rtmp_url }}">
            </div>
				<div class="settings-group">
					<h3>Twitch Bot</h3>
					<label>Bot-Account Name:</label>
					<input type="text" name="bot_nick" value="{{ streamer_config.twitch_bot.bot_nick }}">
					<label>Bot-Account OAuth-Token:</label>
					<input type="password" name="bot_token" value="{{ streamer_config.twitch_bot.bot_token }}">
					<label>Kanal, dem der Bot beitritt:</label>
					<input type="text" name="channel_nick" value="{{ streamer_config.twitch_bot.channel_nick }}">
				</div>
            <div class="settings-group">
                <h3>Konfigurations-Presets</h3>
                <label>Gespeichertes Preset laden / löschen:</label>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <select id="preset-to-load-select" name="preset_to_load" style="width: 100%;">
                        <option value="">-- Preset auswählen --</option>
                        {% for name in config_presets.keys() %}
                        <option value="{{ name }}">{{ name }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" onclick="loadPreset()">Laden</button>
                    <button type="button" onclick="deletePreset()" style="background-color: #c82333;">X</button>
                </div>
                <label>Aktuelle Konfiguration als Preset speichern:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="preset-name-input" name="preset_name" placeholder="Name für das Preset..." style="width: 100%;">
                    <button type="button" onclick="savePreset()" style="background-color: #52c41a;">Speichern</button>
                </div>
            </div>
        </div>

        <div class="settings-grid">
            <fieldset id="overlay-fieldset">
                <div class="settings-group">
                    <h3>Design (Overlay)</h3>
                    <label>Schriftart für "Now Playing"-Text:</label>
                    <select name="ffmpeg_font_file" id="font-select">
                        <option value="" {% if not streamer_config.ffmpeg.font_file %}selected{% endif %}>-- Overlay deaktiviert --</option>
                        {% for font in fonts %}
                        <option value="{{ font }}" {% if streamer_config.ffmpeg.font_file == font %}selected{% endif %}>{{ font }}</option>
                        {% endfor %}
                    </select>
                    <div class="settings-grid" style="grid-template-columns: 1fr 1fr; margin-top: 15px;">
                        <div>
                            <label>Schriftfarbe:</label>
                            <input type="color" name="ffmpeg_font_color" value="{{ streamer_config.ffmpeg.font_color or '#FFFFFF' }}">
                        </div>
                        <div>
                            <label>Box-Farbe:</label>
                            <input type="color" name="ffmpeg_box_color" value="{{ streamer_config.ffmpeg.box_color or '#000000' }}">
                        </div>
                    </div>
                    <label style="margin-top: 10px;">Box-Transparenz: <span id="alpha-value">{{ streamer_config.ffmpeg.box_alpha or '0.5' }}</span></label>
                    <input type="range" name="ffmpeg_box_alpha" min="0.0" max="1.0" step="0.1" value="{{ streamer_config.ffmpeg.box_alpha or '0.5' }}" oninput="document.getElementById('alpha-value').textContent = this.value;">
                    <label style="margin-top: 10px;">Text-Position:</label>
                    <select name="ffmpeg_font_position">
                        <option value="bottom_center" {% if streamer_config.ffmpeg.font_position == 'bottom_center' %}selected{% endif %}>Unten Mitte</option>
                        <option value="top_center" {% if streamer_config.ffmpeg.font_position == 'top_center' %}selected{% endif %}>Oben Mitte</option>
                    </select>
                    <label style="margin-top: 10px;">Schriftgröße:</label>
                    <input type="number" name="ffmpeg_font_size" value="{{ streamer_config.ffmpeg.font_size or 24 }}" min="10" step="1">
                    <hr style="margin: 20px 0;">
                    <h4>Schriftarten verwalten</h4>
                    <div id="font-list" style="max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 10px; margin-bottom: 10px;">
                        {% for font in fonts %}
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px;">
                            <span>{{ font }}</span>
                            <input type="hidden" name="font_name_to_delete" value="{{ font }}">
                            <button type="submit" formaction="/delete_font" formmethod="post" onclick="return confirm('Soll die Schriftart {{ font }} wirklich gelöscht werden?');" style="background: #c82333; padding: 2px 8px; font-size: 12px;">X</button>
                        </div>
                        {% else %}
                        <p>Keine Schriftarten gefunden.</p>
                        {% endfor %}
                    </div>
                    
                    <label>Neue Schriftart hochladen (.ttf, .otf):</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="file" name="font_file" accept=".ttf,.otf">
                        <button type="submit" formaction="/upload_font" formmethod="post" enctype="multipart/form-data">Hochladen</button>
                    </div>
                    </form>
                </div>
            </fieldset>

            <div class="settings-group">
                <h3>FFmpeg</h3>
                <label>Stream-Modus:</label>
                <div class="radio-option">
                    <input type="radio" id="mode_transcode" name="ffmpeg_stream_mode" value="transcode" {% if streamer_config.ffmpeg.stream_mode == 'transcode' or not streamer_config.ffmpeg.stream_mode %}checked{% endif %}>
                    <label for="mode_transcode">Transcoding (Flexibel, hohe CPU-Last)</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="mode_remux" name="ffmpeg_stream_mode" value="remux" {% if streamer_config.ffmpeg.stream_mode == 'remux' %}checked{% endif %}>
                    <label for="mode_remux">Remuxing / Copy (CPU-schonend, strenge Regeln)</label>
                </div>
                <div id="remux-warning" class="warning-box">
                    <strong>⚠️ Achtung!</strong> Im "Remuxing"-Modus müssen ALLE deine Videodateien exakt die gleichen Eigenschaften haben.
                </div>
                <hr>
                <div id="transcode-settings">
                    <label>Encoder (nur für Transcoding-Modus):</label>
                    <select name="ffmpeg_encoder" class="transcode-only">
                        <option value="libx264" {% if streamer_config.ffmpeg.encoder == 'libx264' %}selected{% endif %}>libx264 (CPU, hohe Qualität)</option>
                        <option value="h264_nvenc" {% if streamer_config.ffmpeg.encoder == 'h264_nvenc' %}selected{% endif %}>h264_nvenc (NVIDIA GPU, schnell)</option>
                        <option value="h264_qsv" {% if streamer_config.ffmpeg.encoder == 'h264_qsv' %}selected{% endif %}>h264_qsv (Intel Quick Sync, sehr schnell)</option>
                        <option value="h264_amf" {% if streamer_config.ffmpeg.encoder == 'h264_amf' %}selected{% endif %}>h264_amf (AMD GPU, sehr schnell)</option>
                    </select>
                    <label>Video Bitrate (z.B. 6000k):</label>
                    <input type="text" name="ffmpeg_video_bitrate" value="{{ streamer_config.ffmpeg.video_bitrate }}" class="transcode-only">
                    <label>Audio Bitrate (z.B. 160k):</label>
                    <input type="text" name="ffmpeg_audio_bitrate" value="{{ streamer_config.ffmpeg.audio_bitrate }}" class="transcode-only">
                    <label>Preset (für libx264 Encoder):</label>
                    <select name="ffmpeg_preset" class="transcode-only">
                        <option value="ultrafast" {% if streamer_config.ffmpeg.preset == 'ultrafast' %}selected{% endif %}>Ultrafast</option>
                        <option value="veryfast" {% if streamer_config.ffmpeg.preset == 'veryfast' %}selected{% endif %}>Veryfast</option>
                        <option value="medium" {% if streamer_config.ffmpeg.preset == 'medium' %}selected{% endif %}>Medium</option>
                    </select>
                    <label>Auflösung (z.B. 1920x1080):</label>
                    <input type="text" name="ffmpeg_resolution" value="{{ streamer_config.ffmpeg.resolution }}" class="transcode-only">
                    <label>Framerate (z.B. 60):</label>
                    <input type="text" name="ffmpeg_framerate" value="{{ streamer_config.ffmpeg.framerate }}" class="transcode-only">
                </div>
            </div>
        </div>

        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 15px; margin-top: 20px;">
            <div>
                <button type="button" onclick="saveSettings('save')" style="background-color: #28a745;">
                    Speichern (ohne Neustart)
                </button>
            </div>
            <div style="border-left: 2px solid #ddd; height: 40px; margin: 0 5px;"></div>
            <div>
                <button type="button" onclick="if(confirm('Sichert die Einstellungen und startet den Stream nach dem aktuellen Video neu, damit sie wirksam werden. Sicher?')) saveSettings('save_soft');">
                    Speichern & Sanft Neustarten
                </button>
                <button type="button" onclick="if(confirm('WARNUNG: Sichert die Einstellungen und startet den Stream sofort neu. Dies führt zu einer kurzen Unterbrechung. Sicher?')) saveSettings('save_hard');" style="background-color: #dc3545;">
                    Speichern & Sofort Neustarten
                </button>
            </div>
        </div>
    </form>
</div>

        <div id="manager_config" class="tab-content {% if active_tab == 'manager_config' %}active{% endif %}">
            <h2>Manager Konfiguration (`manager_config.json`)</h2>
            <form action="/save_manager_config" method="post">
				<div class="settings-group">
                    <h3>Globale Einstellungen</h3>
                    <div class="settings-grid" style="grid-template-columns: 1fr 1fr;">
                        <div>
                            <label for="title_prefix">Titel-Prefix (für Twitch):</label>
                            <input type="text" id="title_prefix" name="title_prefix" value="{{ manager_config.title_prefix }}">
                        </div>
                        <div>
                            <label for="overlay_prefix">Overlay-Prefix (für "Now Playing"):</label>
                            <input type="text" id="overlay_prefix" name="overlay_prefix" value="{{ manager_config.overlay_prefix }}">
                        </div>
                    </div>
                    <div class="settings-grid" style="grid-template-columns: 1fr 1fr; margin-top: 15px;">
                         <div>
                            <label for="language">Stream-Sprache:</label>
                            <select id="language" name="language">
                                <option value="de" {% if manager_config.language == 'de' %}selected{% endif %}>Deutsch</option>
                                <option value="en" {% if manager_config.language == 'en' %}selected{% endif %}>English</option>
                            </select>
                        </div>
                    </div>
                    <label for="video_directories" style="margin-top: 15px;">Video-Ordner (ein Pfad pro Zeile):</label>
                    <textarea id="video_directories" name="video_directories" rows="4" style="width: 100%; font-family: inherit;">{{ manager_config.video_directories | join('\n') }}</textarea>
                </div>
                <div class="settings-group">
                    <h3>Thumbnail-Einstellungen</h3>
                    <label for="thumbnail_scale">Thumbnail Skalierung (FFmpeg-Format):</label>
                    <input type="text" id="thumbnail_scale" name="thumbnail_scale" value="{{ manager_config.thumbnail_scale }}">
                    <small>Beispiele: `320:-1` (320px breit), `-1:180` (180px hoch), `320:180` (feste Größe)</small>
                </div>
                <br>
                <button type="submit">Manager-Einstellungen speichern</button>
            </form>
        </div>
		
		<div id="process" class="tab-content {% if active_tab == 'process' %}active{% endif %}">
            <h2>Streamer Prozess-Steuerung</h2>
            <div class="process-controls">
                {% if streamer_is_running %}
                    <div class="status-indicator">
                        <span style="color: green; font-weight: bold;">✔ Streamer-Prozess läuft</span>
                        <form action="/stop_streamer" method="post" style="margin: 0;">
                            <button type="submit" style="background-color: #dc3545;" onclick="return confirm('Bist du sicher, dass du den Streamer-Prozess beenden möchtest?');">Streamer Stoppen</button>
                        </form>
                    </div>
                {% else %}
                    <div class="status-indicator">
                        <span style="color: red; font-weight: bold;">✖ Streamer-Prozess ist offline</span>
                        <form action="/start_streamer" method="post" style="margin: 0;">
                            <button type="submit" style="background-color: #28a745;">Streamer Starten</button>
                        </form>
                    </div>
                {% endif %}
            </div>
            <h3>Live-Log (`streamer.log`)</h3>
            <pre id="log-output">Log-Daten werden geladen...</pre>
			<h3 style="margin-top: 20px;">FFmpeg Live-Log (`ffmpeg.log`)</h3>
            <pre id="ffmpeg-log-output" style="color: #a9a9a9;">FFmpeg-Log wird geladen...</pre>
        </div>
    </div>

    <div id="thumbnail-modal" class="modal" onclick="closeModal()">
        <span class="modal-close">&times;</span>
        <img class="modal-content" id="modal-img">
    </div>


<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script>
        // --- GLOBALE VARIABLEN ---
        let logInterval = null;

        // --- GLOBALE FUNKTIONEN ---

        function loadPreset() {
            const select = document.getElementById('preset-to-load-select');
            const presetName = select.value;
            if (!presetName) {
                alert('Bitte wähle ein Preset zum Laden aus.');
                return;
            }
            const formData = new FormData();
            formData.append('preset_to_load', presetName);
            fetch('/load_config_preset', { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Preset erfolgreich geladen! Die Seite wird neu geladen.');
                        window.location.reload();
                    } else {
                        alert('Fehler beim Laden des Presets: ' + data.error);
                    }
                })
                .catch(error => console.error('Fehler:', error));
        }

        function savePreset() {
            const input = document.getElementById('preset-name-input');
            const presetName = input.value;
            if (!presetName || presetName.trim() === '') {
                alert('Bitte gib einen Namen für das Preset ein.');
                return;
            }
            const form = document.querySelector('form[action="/save_settings"]');
            const formData = new FormData(form);
            formData.append('preset_name', presetName);
            fetch('/save_config_preset', { method: 'POST', body: formData })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Preset erfolgreich gespeichert! Die Seite wird neu geladen.');
                        window.location.reload();
                    } else {
                        alert('Fehler beim Speichern des Presets: ' + data.error);
                    }
                })
                .catch(error => console.error('Fehler:', error));
        }

        function deletePreset() {
            const select = document.getElementById('preset-to-load-select');
            const presetName = select.value;
            if (!presetName) {
                alert('Bitte wähle ein Preset zum Löschen aus.');
                return;
            }
            if (confirm(`Bist du sicher, dass du das Preset "${presetName}" permanent löschen möchtest?`)) {
                const formData = new FormData();
                formData.append('preset_to_delete', presetName);
                fetch('/delete_config_preset', { method: 'POST', body: formData })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Preset erfolgreich gelöscht! Die Seite wird neu geladen.');
                            window.location.reload();
                        } else {
                            alert('Fehler beim Löschen des Presets: ' + data.error);
                        }
                    })
                    .catch(error => console.error('Fehler:', error));
            }
        }

        function saveSettings(action) {
            const form = document.querySelector('form[action="/save_settings"]');
            const formData = new FormData(form);
            formData.append('action', action);
            fetch('/save_settings_js', { method: 'POST', body: formData })
                .then(response => { window.location.reload(); })
                .catch(error => {
                    console.error('Fehler beim Speichern:', error);
                    alert('Ein Fehler beim Speichern ist aufgetreten. Bitte die Konsole prüfen.');
                });
        }

        function updateUiForStreamMode() {
            const remuxRadio = document.getElementById('mode_remux');
            const overlayFieldset = document.getElementById('overlay-fieldset');
            const transcodeOnlyElements = document.querySelectorAll('.transcode-only');
            const fontSelect = document.getElementById('font-select');
            const remuxWarning = document.getElementById('remux-warning');
            if (!remuxRadio || !overlayFieldset) return;
            const isRemux = remuxRadio.checked;
            overlayFieldset.disabled = isRemux;
            transcodeOnlyElements.forEach(el => el.disabled = isRemux);
            if (isRemux) {
                fontSelect.value = "";
                remuxWarning.style.display = 'block';
            } else {
                remuxWarning.style.display = 'none';
            }
        }

        function handleFontChange() {
            const fontSelect = document.getElementById('font-select');
            const transcodeRadio = document.getElementById('mode_transcode');
            if (fontSelect.value !== "") {
                transcodeRadio.checked = true;
                updateUiForStreamMode();
            }
        }

        function handleActionTypeChange() {
            const select = document.getElementById('action-type-select');
            const selectedType = select.value;
            document.querySelectorAll('.action-params').forEach(div => {
                div.style.display = 'none';
            });
            const targetDiv = document.getElementById('params-' + selectedType);
            if (targetDiv) {
                targetDiv.style.display = 'block';
            }
        }

        function saveRotation() {
            const rotationName = document.getElementById('rotation-name-input').value;
            if (!rotationName || rotationName.trim() === "") {
                alert("Bitte gib einen Namen für die Rotation ein.");
                return;
            }
            const rotationContainer = document.getElementById('rotation-sequence');
            const items = rotationContainer.querySelectorAll('.rotation-item');
            const playlistIds = [];
            items.forEach(item => {
                playlistIds.push(item.dataset.id);
            });
            if (playlistIds.length === 0) {
                alert("Die Rotation ist leer. Bitte ziehe Playlists in den Ablauf.");
                return;
            }
            document.getElementById('rotation-name').value = rotationName;
            document.getElementById('rotation-playlist-ids').value = JSON.stringify(playlistIds);
            document.getElementById('rotation-form').submit();
        }

        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].className = tabbuttons[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            history.pushState(null, '', '?active_tab=' + tabName);
            clearInterval(logInterval);

            if (tabName === 'process') {
                updateScriptLog();
                updateFfmpegLog();
                logInterval = setInterval(() => {
                    updateScriptLog();
                    updateFfmpegLog();
                }, 2000);
            } else if (tabName === 'bot') {
                updateBotLogs();
                logInterval = setInterval(updateBotLogs, 2000);
            }
        }

        function updateBotLogs() {
            const botLogOutput = document.getElementById('bot-log-output');
            const chatLogOutput = document.getElementById('chat-log-output');
            fetch('/get_bot_log_content').then(response => response.json()).then(data => {
                if (botLogOutput && botLogOutput.textContent !== data.log_content) {
                    botLogOutput.textContent = data.log_content;
                    botLogOutput.scrollTop = botLogOutput.scrollHeight;
                }
            });
            fetch('/get_chat_log_content').then(response => response.json()).then(data => {
                if (chatLogOutput && chatLogOutput.textContent !== data.log_content) {
                    chatLogOutput.textContent = data.log_content;
                    chatLogOutput.scrollTop = chatLogOutput.scrollHeight;
                }
            });
        }

        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const statusEl = document.getElementById('status-text');
                    const botStatusEl = document.getElementById('bot-status-text');
                    const npEl = document.getElementById('status-np');
                    const barFillEl = document.getElementById('progress-bar-fill');
                    const progressTextEl = document.getElementById('progress-text');
                    const progressBarContainer = document.querySelector('.progress-bar-container');
                    statusEl.textContent = data.status || 'Unknown';
                    botStatusEl.textContent = data.bot_status || 'Unknown';
                    npEl.textContent = data.now_playing || 'N/A';
                    if (data.status === 'Online') { statusEl.style.color = 'green'; }
                    else if (data.status === 'Offline') { statusEl.style.color = 'red'; }
                    else { statusEl.style.color = 'orange'; }
                    if (data.bot_status === 'Online') { botStatusEl.style.color = 'green'; }
                    else if (data.bot_status === 'Offline') { botStatusEl.style.color = 'red'; }
                    else { botStatusEl.style.color = 'orange'; }
                    if (data.status === 'Online' && data.video_duration > 0) {
                        const elapsed = Math.max(0, data.video_elapsed);
                        const duration = data.video_duration;
                        const percent = Math.min(100, (elapsed / duration) * 100);
                        if (barFillEl) barFillEl.style.width = percent + '%';
                        if (progressTextEl) progressTextEl.textContent = `${formatTime(elapsed)} / ${formatTime(duration)}`;
                        if (progressBarContainer) progressBarContainer.style.display = 'block';
                    } else {
                        if (progressBarContainer) progressBarContainer.style.display = 'none';
                    }
                })
                .catch(() => {
                    document.getElementById('status-text').textContent = 'Error';
                    document.getElementById('status-text').style.color = 'red';
                    document.getElementById('bot-status-text').textContent = 'Error';
                    document.getElementById('bot-status-text').style.color = 'red';
                });
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "00:00";
            const date = new Date(null);
            date.setSeconds(seconds);
            return date.toISOString().substr(14, 5);
        }

        function promptToRename(videoId, currentBasename) {
            const currentNameWithoutExt = currentBasename.substring(0, currentBasename.lastIndexOf('.')) || currentBasename;
            const newName = prompt("Bitte gib den neuen Dateinamen ein (ohne Endung):", currentNameWithoutExt);
            if (newName && newName.trim() !== "" && newName !== currentNameWithoutExt) {
                document.getElementById('rename-video-id').value = videoId;
                document.getElementById('rename-new-name').value = newName;
                document.getElementById('rename-form').submit();
            }
        }

        function sortPlaylist() {
            const sortBy = document.getElementById('sort-playlist-by').value;
            const playlistContainer = document.getElementById('playlist-items');
            const items = Array.from(playlistContainer.querySelectorAll('.video-item'));
            items.sort((a, b) => {
                let valA, valB;
                if (sortBy === 'basename') { valA = a.querySelector('.video-name').textContent.toLowerCase(); valB = b.querySelector('.video-name').textContent.toLowerCase(); }
                else if (sortBy === 'title') { valA = a.querySelector('input[name="title"]').value.toLowerCase(); valB = b.querySelector('input[name="title"]').value.toLowerCase(); }
                else if (sortBy === 'game') { valA = a.querySelector('input[name="game"]').value.toLowerCase(); valB = b.querySelector('input[name="game"]').value.toLowerCase(); }
                if (valA < valB) return -1;
                if (valA > valB) return 1;
                return 0;
            });
            items.forEach(item => playlistContainer.appendChild(item));
        }

        function sortTable(columnIndex, tableId) {
            const table = document.getElementById(tableId);
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.rows);
            const currentDir = table.dataset.sortDirection || 'asc';
            const clickedColumn = columnIndex.toString();
            let newDir = 'asc';
            if (table.dataset.sortColumn === clickedColumn && currentDir === 'asc') { newDir = 'desc'; }
            table.dataset.sortColumn = clickedColumn;
            table.dataset.sortDirection = newDir;
            rows.sort((a, b) => {
                const x = a.cells[columnIndex].textContent.toLowerCase();
                const y = b.cells[columnIndex].textContent.toLowerCase();
                if (x < y) return newDir === 'asc' ? -1 : 1;
                if (x > y) return newDir === 'asc' ? 1 : -1;
                return 0;
            });
            rows.forEach(row => tbody.appendChild(row));
            const headers = table.tHead.rows[0].cells;
            for (let i = 0; i < headers.length; i++) {
                const arrowSpan = headers[i].querySelector('.sort-arrow');
                if (arrowSpan) {
                    if (i.toString() === clickedColumn) { arrowSpan.innerHTML = newDir === 'asc' ? '&nbsp;▲' : '&nbsp;▼'; }
                    else { arrowSpan.innerHTML = ''; }
                }
            }
        }

        function toggleScheduleInputs(selectElement) {
            const parent = selectElement.parentElement;
            const timeInput = parent.querySelector('.schedule-input-time');
            const repeatInput = parent.querySelector('.schedule-input-repeat');
            if (selectElement.value === 'time') {
                timeInput.style.display = 'block';
                repeatInput.style.display = 'none';
            } else {
                timeInput.style.display = 'none';
                repeatInput.style.display = 'block';
            }
        }

        function updateScriptLog() {
            fetch('/get_log_content').then(response => response.json()).then(data => {
                const logOutput = document.getElementById('log-output');
                if (logOutput && logOutput.textContent !== data.log_content) {
                    logOutput.textContent = data.log_content;
                    logOutput.scrollTop = logOutput.scrollHeight;
                }
            });
        }

        function updateFfmpegLog() {
            fetch('/get_ffmpeg_log_content').then(response => response.json()).then(data => {
                const logOutput = document.getElementById('ffmpeg-log-output');
                if (logOutput && logOutput.textContent !== data.log_content) {
                    logOutput.textContent = data.log_content;
                    logOutput.scrollTop = logOutput.scrollHeight;
                }
            });
        }

        function bulkSetStatus(enable) {
            const checkboxes = document.querySelectorAll('#playlist-items .video-item:not([style*="display: none"]) input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = enable;
                checkbox.closest('.video-item').classList.toggle('disabled', !enable);
            });
        }

        function filterLibrary() {
            const input = document.getElementById('library-search-box');
            const filter = input.value.toUpperCase();
            const table = document.getElementById('library-table');
            const tr = table.getElementsByTagName('tr');
            for (let i = 1; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName('td')[1];
                if (td) {
                    let txtValue = td.textContent || td.innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) { tr[i].style.display = ""; }
                    else { tr[i].style.display = "none"; }
                }
            }
        }

        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('#library-table tbody tr:not([style*="display: none"]) input[type="checkbox"]');
            checkboxes.forEach(checkbox => { checkbox.checked = source.checked; });
        }

        function filterPlaylist() {
            const input = document.getElementById('search-box');
            const filter = input.value.toUpperCase();
            const items = document.querySelectorAll('#playlist-items .video-item');
            items.forEach(item => {
                const name = item.querySelector('.video-name').textContent.toUpperCase();
                const title = item.querySelector('input[name="title"]').value.toUpperCase();
                const game = item.querySelector('input[name="game"]').value.toUpperCase();
                if (name.includes(filter) || title.includes(filter) || game.includes(filter)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function openModal(src) {
            const modal = document.getElementById('thumbnail-modal');
            const modalImg = document.getElementById('modal-img');
            modal.style.display = "block";
            modalImg.src = src;
        }

        function closeModal() {
            document.getElementById('thumbnail-modal').style.display = "none";
        }


// --- HAUPT-INITIALISIERUNG ---
document.addEventListener('DOMContentLoaded', function() {
            // Alle Initialisierungen, die sofort passieren können
            const actionTypeSelect = document.getElementById('action-type-select');
            if (actionTypeSelect) {
                actionTypeSelect.addEventListener('change', handleActionTypeChange);
                handleActionTypeChange();
            }
            updateUiForStreamMode();
            document.querySelectorAll('input[name="ffmpeg_stream_mode"]').forEach(radio => {
                radio.addEventListener('change', updateUiForStreamMode);
            });
            const fontSelect = document.getElementById('font-select');
            if (fontSelect) {
                fontSelect.addEventListener('change', handleFontChange);
            }

            updateStatus();
            setInterval(updateStatus, 1000);

            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('active_tab');
            const tabButton = document.querySelector(`.tab-button[onclick*="'${activeTab || 'playlist'}'"]`);
            if (tabButton) tabButton.click();
            
            // --- DIE LÖSUNG: Initialisiere Drag&Drop mit einer winzigen Verzögerung ---
    setTimeout(function() {
        // Drag & Drop für Playlist
        const playlistEl = document.getElementById('playlist-items');
        if (playlistEl) {
            new Sortable(playlistEl, {
                handle: '.drag-handle',
                animation: 150
            });
        }
        // ... andere Sortable-Initialisierungen ...
        console.log("Drag & Drop wurde mit Verzögerung initialisiert.");
    }, 100); // 100 Millisekunden Verzögerung
});
        
        
// NEUE, ROBUSTERE VERSION
function savePlaylistChanges() {
    const playlistItems = document.querySelectorAll('#playlist-items .video-item');
    const playlistData = [];
    
    // 1. Lese die Daten aus jedem Eintrag in der aktuellen DOM-Reihenfolge aus
    playlistItems.forEach(item => {
        const video_id = item.querySelector('input[name="video_id"]').value;
        const title = item.querySelector('input[name="title"]').value;
        const game = item.querySelector('input[name="game"]').value;
        const checkbox = item.querySelector('input[name="active_videos"]');
        
        playlistData.push({
            id: video_id,
            title: title,
            game: game,
            active: checkbox.checked // Hier wird der Status (true/false) direkt erfasst
        });
    });

    // Hole die ID der bearbeiteten Playlist aus dem versteckten Feld
    const editingPlaylistId = document.querySelector('input[name="editing_playlist_id"]').value;

    // 2. Sende die gesammelten Daten als JSON an den Server
    fetch('/save_metadata', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            editing_playlist_id: editingPlaylistId,
            playlist_data: playlistData 
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload(); // Lade die Seite neu, um die gespeicherten Änderungen und die Erfolgsmeldung zu sehen
        } else {
            alert('Fehler beim Speichern: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Schwerwiegender Fehler:', error);
        alert('Ein Fehler ist aufgetreten. Prüfe die Konsole.');
    });
}

// Fügen Sie diese zwei Funktionen zu Ihrem <script>-Block hinzu

function duplicateEntry(entryIndex, editingPlaylistId) {
    const formData = new FormData();
    formData.append('entry_index', entryIndex);
    formData.append('editing_playlist_id', editingPlaylistId);

    fetch('/duplicate_entry', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            window.location.reload(); // Lade die Seite neu, um das Ergebnis zu sehen
        } else {
            alert("Fehler beim Duplizieren.");
        }
    });
}

// Ersetzen Sie die alte removeEntry-Funktion mit dieser.
function removeEntry(entryIndex, editingPlaylistId) {
    if (!confirm('Soll der Eintrag wirklich aus der Playlist entfernt werden?')) {
        return;
    }
    const formData = new FormData();
    // Wir senden jetzt den Index statt der Video-ID
    formData.append('entry_index', entryIndex); 
    formData.append('editing_playlist_id', editingPlaylistId);

    fetch('/remove_from_playlist', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            window.location.reload();
        } else {
            alert("Fehler beim Entfernen.");
        }
    });
}
    </script>
</body>
</body>
